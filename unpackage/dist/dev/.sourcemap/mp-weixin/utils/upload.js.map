{"version":3,"file":"upload.js","sources":["utils/upload.js"],"sourcesContent":["import { api } from './api.js'\n\n/**\n * å‹ç¼©å›¾ç‰‡\n * @param {string} filePath å›¾ç‰‡è·¯å¾„\n * @param {number} quality å‹ç¼©è´¨é‡ 0-1\n * @returns {Promise<string>} å‹ç¼©åçš„å›¾ç‰‡è·¯å¾„\n */\nexport function compressImage(filePath, quality = 0.8) {\n  return new Promise((resolve, reject) => {\n    uni.compressImage({\n      src: filePath,\n      quality: Math.floor(quality * 100),\n      success: (res) => {\n        resolve(res.tempFilePath)\n      },\n      fail: (error) => {\n        console.error('å›¾ç‰‡å‹ç¼©å¤±è´¥:', error)\n        reject(error)\n      }\n    })\n  })\n}\n\n/**\n * ä¸Šä¼ å•å¼ å›¾ç‰‡\n * @param {string} filePath å›¾ç‰‡è·¯å¾„\n * @param {string} type å›¾ç‰‡ç±»å‹ (avatar, gallery, etc.)\n * @returns {Promise<string>} ä¸Šä¼ åçš„å›¾ç‰‡URL\n */\nexport async function uploadImage(filePath, type = 'gallery') {\n  try {\n    console.log('=== å‰ç«¯å›¾ç‰‡ä¸Šä¼ è°ƒè¯•ä¿¡æ¯ ===');\n    console.log('æ–‡ä»¶è·¯å¾„:', filePath);\n    console.log('ä¸Šä¼ ç±»å‹:', type);\n    console.log('ä¸Šä¼ URL:', 'https://pet-api.zbinli.cn/api/media/upload');\n    console.log('Token:', uni.getStorageSync('token'));\n    \n    // ä¸Šä¼ åˆ°åç«¯æœåŠ¡å™¨\n    const uploadTask = uni.uploadFile({\n      url: 'https://pet-api.zbinli.cn/api/media/upload',\n      filePath: filePath,\n      name: 'file',\n      formData: {\n        type: type\n      },\n      header: {\n        'Authorization': `Bearer ${uni.getStorageSync('token')}`\n      }\n    })\n    \n    return new Promise((resolve, reject) => {\n      uploadTask.then((res) => {\n        console.log('ğŸ“¤ ä¸Šä¼ å“åº”:');\n        console.log('- çŠ¶æ€ç :', res.statusCode);\n        console.log('- å“åº”å¤´:', res.header);\n        console.log('- å“åº”æ•°æ®:', res.data);\n        \n        if (res.statusCode === 200) {\n          const data = JSON.parse(res.data)\n          console.log('ğŸ“‹ è§£æåçš„æ•°æ®:', data);\n          \n          if (data.success) {\n            // è¿”å›å®Œæ•´çš„å›¾ç‰‡URL\n            const imageUrl = `https://pet-api.zbinli.cn/uploads/${data.filename}`\n            console.log('âœ… å›¾ç‰‡ä¸Šä¼ æˆåŠŸ:');\n            console.log('- æ–‡ä»¶å:', data.filename);\n            console.log('- ç›¸å¯¹URL:', data.url);\n            console.log('- å®Œæ•´URL:', imageUrl);\n            console.log('- åª’ä½“ID:', data.id);\n            \n            // æµ‹è¯•å›¾ç‰‡URLæ˜¯å¦å¯è®¿é—®\n            uni.request({\n              url: imageUrl,\n              method: 'HEAD',\n              success: (testRes) => {\n                console.log('ğŸ” å›¾ç‰‡URLæµ‹è¯•ç»“æœ:', testRes.statusCode);\n              },\n              fail: (testErr) => {\n                console.error('âŒ å›¾ç‰‡URLæµ‹è¯•å¤±è´¥:', testErr);\n              }\n            });\n            \n            resolve(imageUrl)\n          } else {\n            console.error('âŒ ä¸Šä¼ å¤±è´¥:', data.message);\n            reject(new Error(data.message || 'ä¸Šä¼ å¤±è´¥'))\n          }\n        } else {\n          console.error('âŒ HTTPé”™è¯¯:', res.statusCode);\n          reject(new Error(`ä¸Šä¼ å¤±è´¥: ${res.statusCode}`))\n        }\n      }).catch((error) => {\n        console.error('âŒ å›¾ç‰‡ä¸Šä¼ å¼‚å¸¸:', error)\n        reject(error)\n      })\n    })\n  } catch (error) {\n    console.error('âŒ å›¾ç‰‡ä¸Šä¼ å¤±è´¥:', error)\n    throw error\n  }\n}\n\n/**\n * æ‰¹é‡ä¸Šä¼ å›¾ç‰‡\n * @param {Array<string>} filePaths å›¾ç‰‡è·¯å¾„æ•°ç»„\n * @param {string} type å›¾ç‰‡ç±»å‹\n * @param {string} petId å® ç‰©IDï¼ˆå¯é€‰ï¼‰\n * @returns {Promise<Array<string>>} ä¸Šä¼ åçš„å›¾ç‰‡URLæ•°ç»„\n */\nexport async function uploadImages(filePaths, type = 'gallery', petId = null) {\n  try {\n    uni.showLoading({ title: `ä¸Šä¼ ${filePaths.length}å¼ å›¾ç‰‡ä¸­...` })\n    \n    // æ‰¹é‡å‹ç¼©\n    const compressedPaths = await Promise.all(\n      filePaths.map(filePath => compressImage(filePath, 0.7))\n    )\n    \n    // æ‰¹é‡ä¸Šä¼ \n    const uploadPromises = compressedPaths.map(filePath => uploadImage(filePath, type))\n    const urls = await Promise.all(uploadPromises)\n    \n    // å¦‚æœæœ‰å® ç‰©IDï¼Œåˆ›å»ºåª’ä½“è®°å½•\n    if (petId && urls.length > 0) {\n      try {\n        await api.createMedia({\n          petId,\n          type: 'image',\n          urls: urls,\n          description: 'å® ç‰©ç…§ç‰‡'\n        })\n      } catch (error) {\n        console.warn('åˆ›å»ºåª’ä½“è®°å½•å¤±è´¥:', error)\n      }\n    }\n    \n    uni.hideLoading()\n    return urls\n  } catch (error) {\n    uni.hideLoading()\n    throw error\n  }\n}\n\n/**\n * ä¸Šä¼ åˆ°å¯¹è±¡å­˜å‚¨\n * @param {string} filePath æœ¬åœ°æ–‡ä»¶è·¯å¾„\n * @param {string} uploadUrl ä¸Šä¼ URL\n * @param {Object} formData è¡¨å•æ•°æ®\n * @param {string} fileKey æ–‡ä»¶key\n * @returns {Promise<Object>} ä¸Šä¼ ç»“æœ\n */\nfunction uploadToOSS(filePath, uploadUrl, formData, fileKey) {\n  return new Promise((resolve, reject) => {\n    const uploadTask = uni.uploadFile({\n      url: uploadUrl,\n      filePath: filePath,\n      name: 'file',\n      formData: {\n        ...formData,\n        key: fileKey\n      },\n      success: (res) => {\n        if (res.statusCode === 200 || res.statusCode === 204) {\n          resolve(res)\n        } else {\n          reject(new Error(`ä¸Šä¼ å¤±è´¥: ${res.statusCode}`))\n        }\n      },\n      fail: (error) => {\n        reject(error)\n      }\n    })\n    \n    // ç›‘å¬ä¸Šä¼ è¿›åº¦\n    uploadTask.onProgressUpdate((res) => {\n      console.log('ä¸Šä¼ è¿›åº¦:', res.progress + '%')\n    })\n  })\n}\n\n/**\n * é€‰æ‹©å¹¶ä¸Šä¼ å¤´åƒ\n * @returns {Promise<string>} ä¸Šä¼ åçš„å¤´åƒURL\n */\nexport async function pickAndUploadAvatar() {\n  try {\n    const res = await uni.chooseImage({\n      count: 1,\n      sizeType: ['compressed'],\n      sourceType: ['album', 'camera']\n    })\n    \n    const filePath = res.tempFilePaths[0]\n    \n    // å‹ç¼©å›¾ç‰‡\n    const compressedPath = await compressImage(filePath, 0.8)\n    \n    // æ˜¾ç¤ºä¸Šä¼ è¿›åº¦\n    uni.showLoading({ title: 'ä¸Šä¼ å¤´åƒä¸­...' })\n    \n    // ä¸Šä¼ å¤´åƒ\n    const avatarUrl = await uploadImage(compressedPath, 'avatar')\n    \n    uni.hideLoading()\n    uni.showToast({ title: 'å¤´åƒä¸Šä¼ æˆåŠŸ', icon: 'success' })\n    \n    return avatarUrl\n  } catch (error) {\n    uni.hideLoading()\n    console.error('é€‰æ‹©å¤´åƒå¤±è´¥:', error)\n    uni.showToast({ title: 'å¤´åƒä¸Šä¼ å¤±è´¥', icon: 'none' })\n    throw error\n  }\n}\n\n/**\n * é€‰æ‹©å¹¶ä¸Šä¼ ç…§ç‰‡\n * @param {number} maxCount æœ€å¤§é€‰æ‹©æ•°é‡\n * @returns {Promise<Array<string>>} ä¸Šä¼ åçš„ç…§ç‰‡URLæ•°ç»„\n */\nexport async function pickAndUploadPhotos(maxCount = 9) {\n  try {\n    const res = await uni.chooseImage({\n      count: maxCount,\n      sizeType: ['compressed'],\n      sourceType: ['album', 'camera']\n    })\n    \n    const filePaths = res.tempFilePaths\n    \n    // æ˜¾ç¤ºä¸Šä¼ è¿›åº¦\n    uni.showLoading({ title: `ä¸Šä¼ ${filePaths.length}å¼ ç…§ç‰‡ä¸­...` })\n    \n    // æ‰¹é‡ä¸Šä¼ \n    const urls = await uploadImages(filePaths, 'gallery')\n    \n    uni.hideLoading()\n    uni.showToast({ title: `æˆåŠŸä¸Šä¼ ${urls.length}å¼ ç…§ç‰‡`, icon: 'success' })\n    \n    return urls\n  } catch (error) {\n    uni.hideLoading()\n    console.error('é€‰æ‹©ç…§ç‰‡å¤±è´¥:', error)\n    uni.showToast({ title: 'ç…§ç‰‡ä¸Šä¼ å¤±è´¥', icon: 'none' })\n    throw error\n  }\n}\n"],"names":["uni","api"],"mappings":"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"}