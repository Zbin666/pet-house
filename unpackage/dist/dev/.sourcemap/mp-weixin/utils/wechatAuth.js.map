{"version":3,"file":"wechatAuth.js","sources":["utils/wechatAuth.js"],"sourcesContent":["// 微信授权登录工具\r\nimport { api } from './api.js'\r\n\r\n/**\r\n * 微信授权登录 - 会弹出微信账号选择页面\r\n * 这是真正的微信登录，用户可以选择不同的微信账号\r\n */\r\nexport const wechatAuthLogin = () => {\r\n  return new Promise((resolve, reject) => {\r\n    // 检查是否已同意协议\r\n    const agreed = uni.getStorageSync('agreed')\r\n    if (!agreed) {\r\n      uni.showToast({\r\n        title: '请先同意用户协议',\r\n        icon: 'none'\r\n      })\r\n      return reject(new Error('请先同意用户协议'))\r\n    }\r\n\r\n    // 第一步：获取微信登录凭证\r\n    uni.login({\r\n      provider: 'weixin',\r\n      success: (loginRes) => {\r\n        console.log('微信登录凭证获取成功:', loginRes)\r\n        \r\n        // 第二步：获取用户授权信息（这里会弹出微信授权页面）\r\n        // 注意：getUserProfile 必须在用户直接点击事件中调用\r\n        getUserProfile()\r\n          .then(async (userInfo) => {\r\n            try {\r\n              // 第三步：调用后端登录接口\r\n              const result = await api.login({\r\n                code: loginRes.code,\r\n                nickname: userInfo.nickName,\r\n                avatarUrl: userInfo.avatarUrl\r\n              })\r\n              \r\n              // 保存登录信息\r\n              uni.setStorageSync('token', result.token)\r\n              uni.setStorageSync('userInfo', result.user)\r\n              \r\n              console.log('微信登录成功:', result)\r\n              resolve(result)\r\n            } catch (error) {\r\n              console.error('微信登录失败:', error)\r\n              reject(error)\r\n            }\r\n          })\r\n          .catch((error) => {\r\n            console.error('获取用户授权信息失败:', error)\r\n            reject(error)\r\n          })\r\n      },\r\n      fail: (error) => {\r\n        console.error('获取微信登录凭证失败:', error)\r\n        reject(error)\r\n      }\r\n    })\r\n  })\r\n}\r\n\r\n/**\r\n * 获取用户授权信息 - 会弹出微信授权页面\r\n * 用户可以选择不同的微信账号进行授权\r\n */\r\nexport const getUserProfile = () => {\r\n  return new Promise((resolve, reject) => {\r\n    uni.getUserProfile({\r\n      desc: '用于完善用户资料', // 声明获取用户个人信息后的用途\r\n      success: (res) => {\r\n        console.log('获取用户授权信息成功:', res)\r\n        resolve(res.userInfo)\r\n      },\r\n      fail: (error) => {\r\n        console.error('获取用户授权信息失败:', error)\r\n        // 如果用户拒绝授权，给出友好提示\r\n        if (error.errMsg && error.errMsg.includes('deny')) {\r\n          uni.showToast({\r\n            title: '需要授权才能登录',\r\n            icon: 'none'\r\n          })\r\n        }\r\n        reject(error)\r\n      }\r\n    })\r\n  })\r\n}\r\n\r\n/**\r\n * 微信静默登录 - 不弹出授权页面\r\n * 适用于已经授权过的用户\r\n */\r\nexport const wechatSilentLogin = () => {\r\n  return new Promise((resolve, reject) => {\r\n    uni.login({\r\n      provider: 'weixin',\r\n      success: async (loginRes) => {\r\n        try {\r\n          console.log('微信静默登录成功:', loginRes)\r\n          \r\n          // 调用后端登录接口\r\n          const result = await api.login({\r\n            code: loginRes.code,\r\n            nickname: '微信用户',\r\n            avatarUrl: ''\r\n          })\r\n          \r\n          // 保存登录信息\r\n          uni.setStorageSync('token', result.token)\r\n          uni.setStorageSync('userInfo', result.user)\r\n          \r\n          resolve(result)\r\n        } catch (error) {\r\n          console.error('微信静默登录失败:', error)\r\n          reject(error)\r\n        }\r\n      },\r\n      fail: (error) => {\r\n        console.error('微信静默登录失败:', error)\r\n        reject(error)\r\n      }\r\n    })\r\n  })\r\n}\r\n\r\n/**\r\n * 检查微信登录状态\r\n */\r\nexport const checkWechatLoginStatus = () => {\r\n  return new Promise((resolve, reject) => {\r\n    uni.checkSession({\r\n      success: () => {\r\n        console.log('微信登录状态有效')\r\n        resolve(true)\r\n      },\r\n      fail: () => {\r\n        console.log('微信登录状态已失效')\r\n        resolve(false)\r\n      }\r\n    })\r\n  })\r\n}\r\n\r\n/**\r\n * 微信登录状态失效处理\r\n */\r\nexport const handleWechatSessionExpired = () => {\r\n  uni.showModal({\r\n    title: '登录状态已失效',\r\n    content: '请重新登录',\r\n    showCancel: false,\r\n    success: () => {\r\n      // 清除本地存储\r\n      uni.removeStorageSync('token')\r\n      uni.removeStorageSync('userInfo')\r\n      \r\n      // 跳转到登录页\r\n      uni.reLaunch({\r\n        url: '/pages/login/login'\r\n      })\r\n    }\r\n  })\r\n}\r\n"],"names":["uni","api"],"mappings":";;;AAOY,MAAC,kBAAkB,MAAM;AACnC,SAAO,IAAI,QAAQ,CAAC,SAAS,WAAW;AAEtC,UAAM,SAASA,cAAAA,MAAI,eAAe,QAAQ;AAC1C,QAAI,CAAC,QAAQ;AACXA,oBAAAA,MAAI,UAAU;AAAA,QACZ,OAAO;AAAA,QACP,MAAM;AAAA,MACd,CAAO;AACD,aAAO,OAAO,IAAI,MAAM,UAAU,CAAC;AAAA,IACpC;AAGDA,kBAAAA,MAAI,MAAM;AAAA,MACR,UAAU;AAAA,MACV,SAAS,CAAC,aAAa;AACrBA,sBAAAA,MAAY,MAAA,OAAA,6BAAA,eAAe,QAAQ;AAInC,uBAAgB,EACb,KAAK,OAAO,aAAa;AACxB,cAAI;AAEF,kBAAM,SAAS,MAAMC,UAAG,IAAC,MAAM;AAAA,cAC7B,MAAM,SAAS;AAAA,cACf,UAAU,SAAS;AAAA,cACnB,WAAW,SAAS;AAAA,YACpC,CAAe;AAGDD,0BAAAA,MAAI,eAAe,SAAS,OAAO,KAAK;AACxCA,0BAAAA,MAAI,eAAe,YAAY,OAAO,IAAI;AAE1CA,0BAAAA,gDAAY,WAAW,MAAM;AAC7B,oBAAQ,MAAM;AAAA,UACf,SAAQ,OAAO;AACdA,0BAAAA,MAAc,MAAA,SAAA,6BAAA,WAAW,KAAK;AAC9B,mBAAO,KAAK;AAAA,UACb;AAAA,QACb,CAAW,EACA,MAAM,CAAC,UAAU;AAChBA,wBAAAA,MAAc,MAAA,SAAA,6BAAA,eAAe,KAAK;AAClC,iBAAO,KAAK;AAAA,QACxB,CAAW;AAAA,MACJ;AAAA,MACD,MAAM,CAAC,UAAU;AACfA,sBAAAA,MAAA,MAAA,SAAA,6BAAc,eAAe,KAAK;AAClC,eAAO,KAAK;AAAA,MACb;AAAA,IACP,CAAK;AAAA,EACL,CAAG;AACH;AAMO,MAAM,iBAAiB,MAAM;AAClC,SAAO,IAAI,QAAQ,CAAC,SAAS,WAAW;AACtCA,kBAAAA,MAAI,eAAe;AAAA,MACjB,MAAM;AAAA;AAAA,MACN,SAAS,CAAC,QAAQ;AAChBA,sBAAAA,MAAY,MAAA,OAAA,6BAAA,eAAe,GAAG;AAC9B,gBAAQ,IAAI,QAAQ;AAAA,MACrB;AAAA,MACD,MAAM,CAAC,UAAU;AACfA,sBAAAA,MAAA,MAAA,SAAA,6BAAc,eAAe,KAAK;AAElC,YAAI,MAAM,UAAU,MAAM,OAAO,SAAS,MAAM,GAAG;AACjDA,wBAAAA,MAAI,UAAU;AAAA,YACZ,OAAO;AAAA,YACP,MAAM;AAAA,UAClB,CAAW;AAAA,QACF;AACD,eAAO,KAAK;AAAA,MACb;AAAA,IACP,CAAK;AAAA,EACL,CAAG;AACH;;"}