"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const e=require("../common/vendor.js"),o=require("./api.js");function t(o,t=.8){return new Promise(((n,s)=>{e.index.compressImage({src:o,quality:Math.floor(100*t),success:e=>{n(e.tempFilePath)},fail:e=>{console.error("å›¾ç‰‡åŽ‹ç¼©å¤±è´¥:",e),s(e)}})}))}async function n(o,t="gallery"){try{console.log("=== å‰ç«¯å›¾ç‰‡ä¸Šä¼ è°ƒè¯•ä¿¡æ¯ ==="),console.log("æ–‡ä»¶è·¯å¾„:",o),console.log("ä¸Šä¼ ç±»åž‹:",t),console.log("ä¸Šä¼ URL:","https://pet-api.zbinli.cn/api/media/upload"),console.log("Token:",e.index.getStorageSync("token"));const n=e.index.uploadFile({url:"https://pet-api.zbinli.cn/api/media/upload",filePath:o,name:"file",formData:{type:t},header:{Authorization:`Bearer ${e.index.getStorageSync("token")}`}});return new Promise(((o,t)=>{n.then((n=>{if(console.log("ðŸ“¤ ä¸Šä¼ å“åº”:"),console.log("- çŠ¶æ€ç :",n.statusCode),console.log("- å“åº”å¤´:",n.header),console.log("- å“åº”æ•°æ®:",n.data),200===n.statusCode){const s=JSON.parse(n.data);if(console.log("ðŸ“‹ è§£æžåŽçš„æ•°æ®:",s),s.success){const t=`https://pet-api.zbinli.cn/uploads/${s.filename}`;console.log("âœ… å›¾ç‰‡ä¸Šä¼ æˆåŠŸ:"),console.log("- æ–‡ä»¶å:",s.filename),console.log("- ç›¸å¯¹URL:",s.url),console.log("- å®Œæ•´URL:",t),console.log("- åª’ä½“ID:",s.id),e.index.request({url:t,method:"HEAD",success:e=>{console.log("ðŸ” å›¾ç‰‡URLæµ‹è¯•ç»“æžœ:",e.statusCode)},fail:e=>{console.error("âŒ å›¾ç‰‡URLæµ‹è¯•å¤±è´¥:",e)}}),o(t)}else console.error("âŒ ä¸Šä¼ å¤±è´¥:",s.message),t(new Error(s.message||"ä¸Šä¼ å¤±è´¥"))}else console.error("âŒ HTTPé”™è¯¯:",n.statusCode),t(new Error(`ä¸Šä¼ å¤±è´¥: ${n.statusCode}`))})).catch((e=>{console.error("âŒ å›¾ç‰‡ä¸Šä¼ å¼‚å¸¸:",e),t(e)}))}))}catch(n){throw console.error("âŒ å›¾ç‰‡ä¸Šä¼ å¤±è´¥:",n),n}}exports.compressImage=t,exports.pickAndUploadAvatar=async function(){try{const o=(await e.index.chooseImage({count:1,sizeType:["compressed"],sourceType:["album","camera"]})).tempFilePaths[0],s=await t(o,.8);e.index.showLoading({title:"ä¸Šä¼ å¤´åƒä¸­..."});const a=await n(s,"avatar");return e.index.hideLoading(),e.index.showToast({title:"å¤´åƒä¸Šä¼ æˆåŠŸ",icon:"success"}),a}catch(o){throw e.index.hideLoading(),console.error("é€‰æ‹©å¤´åƒå¤±è´¥:",o),e.index.showToast({title:"å¤´åƒä¸Šä¼ å¤±è´¥",icon:"none"}),o}},exports.uploadImage=n,exports.uploadImages=async function(s,a="gallery",r=null){try{e.index.showLoading({title:`ä¸Šä¼ ${s.length}å¼ å›¾ç‰‡ä¸­...`});const i=(await Promise.all(s.map((e=>t(e,.7))))).map((e=>n(e,a))),c=await Promise.all(i);if(r&&c.length>0)try{await o.api.createMedia({petId:r,type:"image",urls:c,description:"å® ç‰©ç…§ç‰‡"})}catch(l){console.warn("åˆ›å»ºåª’ä½“è®°å½•å¤±è´¥:",l)}return e.index.hideLoading(),c}catch(l){throw e.index.hideLoading(),l}};
