"use strict";const e=require("../../common/vendor.js"),n=require("../../common/assets.js"),t=require("../../utils/api.js"),o=require("../../utils/auth.js");if(!Array){e.resolveComponent("login")()}const a={__name:"login",setup(a){const i=e.ref(!1),s=e.ref(!1),r=e.ref({title:"完善用户信息",content:"授权登录后，开始使用完整功能"}),c=e.ref(!1);function l(){i.value=!i.value,e.index.setStorageSync("agreed",i.value)}async function u(){if(!i.value)return void e.index.showToast({title:"请先同意用户协议",icon:"none"});const n=e.index.getStorageSync("basicUserInfo"),o=e.index.getStorageSync("userInfo"),a=n||o;if(a&&a.nickname&&a.avatarUrl){s.value=!0;try{const n=await t.api.login({code:`silent_login_${Date.now()}`,nickname:a.nickname,avatarUrl:a.avatarUrl});n.token&&(e.index.setStorageSync("token",n.token),e.index.setStorageSync("userInfo",n.user),e.index.removeStorageSync("basicUserInfo")),e.index.showToast({title:"登录成功",icon:"success"}),setTimeout((()=>{e.index.switchTab({url:"/pages/index/index"})}),1500)}catch(r){c.value=!0,e.index.showToast({title:"登录失败，请重新选择",icon:"none"})}finally{s.value=!1}}else c.value=!0}async function d(n){c.value=!1,s.value=!0;try{let o="",a="";n.target&&n.target.res&&(o=n.target.res.nickName||"",a=n.target.res.avatarUrl||"");const i=await t.api.login({code:`plugin_login_${Date.now()}`,nickname:o,avatarUrl:a});i.token&&e.index.setStorageSync("token",i.token),i.user&&(e.index.setStorageSync("userInfo",i.user),e.index.removeStorageSync("basicUserInfo")),e.index.showToast({title:"登录成功",icon:"success"}),setTimeout((()=>{e.index.switchTab({url:"/pages/index/index"})}),1500)}catch(o){e.index.showToast({title:"登录失败",icon:"error"})}finally{s.value=!1}}function g(n){c.value=!1,e.index.showToast({title:"登录失败",icon:"error"})}function v(e){c.value=!1}function x(){e.index.showModal({title:"用户协议",content:"这里是用户协议的内容...",showCancel:!1})}function f(){e.index.showModal({title:"隐私政策",content:"这里是隐私政策的内容...",showCancel:!1})}return e.onMounted((async()=>{const n=e.index.getStorageSync("agreed");i.value=n||!1;try{const n=o.checkLogin();n.token&&(o.isTokenValid(n.token),await t.api.getProfile(),e.index.switchTab({url:"/pages/index/index"}))}catch(a){}})),(t,o)=>({a:r.value,b:e.o(d),c:e.o(g),d:e.o(v),e:c.value,f:n._imports_0,g:n._imports_1,h:e.t(s.value?"登录中...":"微信登录"),i:s.value,j:e.o(u),k:i.value?1:"",l:e.o(x),m:e.o(f),n:e.o(l)})}},i=e._export_sfc(a,[["__scopeId","data-v-44a58871"]]);wx.createPage(i);
