"use strict";const e=require("../../common/vendor.js"),a=require("../../common/assets.js"),t=require("../../utils/api.js"),i=require("../../utils/upload.js"),n=Object.assign({name:"SettingsIndex"},{__name:"setting",setup(n){const l=new Map,s=e.ref({id:"",name:"",desc:"",phone:"",email:"",avatar:"/static/user/user.png",registerTime:""}),r=e.ref(!1),o=e.reactive({name:"",desc:"",phone:"",email:"",avatar:""}),c=e.reactive({notifications:!0,privacy:!1}),u=e.ref("—");function v(a){if(!a)return"/static/user/user.png";let t=a;return t.startsWith("/uploads/")&&(t=`https://pet-api.zbinli.cn${t}`),t.startsWith("http://pet-api.zbinli.cn")&&(t=t.replace("http://pet-api.zbinli.cn","https://pet-api.zbinli.cn")),t=t.replace("://pet-api.zbinli.cn:80","://pet-api.zbinli.cn"),t.startsWith("wxfile://")||t.startsWith("/static/")?t:l.has(t)?l.get(t):(e.index.downloadFile({url:t,success:e=>{200===e.statusCode&&e.tempFilePath?(l.set(t,e.tempFilePath),s.value={...s.value||{}}):(l.set(t,"/static/user/user.png"),s.value={...s.value||{}})},fail:()=>{l.set(t,"/static/user/user.png"),s.value={...s.value||{}}}}),"/static/user/user.png")}function p(e){try{e&&e.target&&(e.target.src="/static/user/user.png")}catch{}}function d(e){}function h(){r.value=!0,Object.assign(o,{name:s.value.name,desc:s.value.desc,phone:s.value.phone,email:s.value.email,avatar:s.value.avatar})}function m(){r.value=!1}async function g(){try{const a={nickname:o.name,email:o.email,phone:o.phone,bio:o.desc,avatarUrl:o.avatar&&o.avatar.startsWith("http")?o.avatar:void 0};Object.keys(a).forEach((e=>void 0===a[e]&&delete a[e])),await t.api.updateProfile(a),s.value={...s.value,name:o.name,desc:o.desc,phone:o.phone,email:o.email,avatar:o.avatar||s.value.avatar},r.value=!1,e.index.showToast({title:"保存成功",icon:"success"})}catch(a){e.index.showToast({title:"保存失败",icon:"none"})}}async function f(){try{const a=await i.pickAndUploadAvatar();await t.api.updateProfile({avatarUrl:a}),r.value&&(o.avatar=a),s.value.avatar=a,s.value.avatarUrl=a,e.index.showToast({title:"头像已更新",icon:"success"})}catch(a){e.index.showToast({title:"头像更新失败",icon:"none"})}}function y(){e.index.showModal({title:"确认清除",content:"确定要清除所有缓存吗？",success:a=>{if(a.confirm)try{e.index.clearStorageSync(),u.value="0 项",e.index.showToast({title:"已清除",icon:"success"})}catch(t){}}})}function w(e){if(!e)return"";try{const a=new Date(e),t=a.getFullYear(),i=`${a.getMonth()+1}`.padStart(2,"0");return`${t}-${i}-${`${a.getDate()}`.padStart(2,"0")}`}catch(a){return""}}return e.onLoad((()=>{e.index.setNavigationBarTitle({title:"个人设置"}),e.index.setNavigationBarColor({frontColor:"#000000",backgroundColor:"#fff1a8"});try{const a=e.index.getStorageInfoSync().keys||[];u.value=`${a.length} 项`}catch(a){u.value="—"}!async function(){try{const[e,a]=await Promise.all([t.api.getProfile(),t.api.getSettings().catch((()=>({})))]);s.value={id:(null==e?void 0:e.id)||"",name:(null==e?void 0:e.nickname)||"新用户",desc:(null==e?void 0:e.bio)||"",phone:(null==e?void 0:e.phone)||"",email:(null==e?void 0:e.email)||"",avatar:(null==e?void 0:e.avatarUrl)||"/static/user/user.png",registerTime:w(null==e?void 0:e.createdAt)}}catch(a){s.value={id:"",name:"新用户",desc:"",phone:"",email:"",avatar:"/static/user/user.png",registerTime:""}}}()})),(t,i)=>e.e({a:v(s.value.avatar),b:e.o(p),c:e.o(d),d:e.o(f),e:e.t(s.value.name),f:e.t(s.value.desc),g:!r.value},r.value?{j:e.o(m),k:e.o(g)}:{h:a._imports_1$5,i:e.o(h)},{l:!r.value},r.value?{n:o.name,o:e.o((e=>o.name=e.detail.value))}:{m:e.t(s.value.name)},{p:!r.value},r.value?{r:o.desc,s:e.o((e=>o.desc=e.detail.value))}:{q:e.t(s.value.desc||"暂无简介")},{t:!r.value},r.value?{w:o.phone,x:e.o((e=>o.phone=e.detail.value))}:{v:e.t(s.value.phone||"未绑定")},{y:!r.value},r.value?{A:o.email,B:e.o((e=>o.email=e.detail.value))}:{z:e.t(s.value.email||"未绑定")},{C:e.t(s.value.registerTime),D:c.notifications,E:e.o((e=>c.notifications=e.detail.value)),F:c.privacy,G:e.o((e=>c.privacy=e.detail.value)),H:e.t(u.value),I:e.o(y)})}}),l=e._export_sfc(n,[["__scopeId","data-v-5296c2e3"]]);wx.createPage(l);
