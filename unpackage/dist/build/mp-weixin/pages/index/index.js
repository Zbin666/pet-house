"use strict";const e=require("../../common/vendor.js"),t=require("../../common/assets.js"),n=require("../../utils/store.js"),l=require("../../utils/api.js"),o=Object.assign({name:"HomeIndex"},{__name:"index",setup(o){const a=e.ref(!1),i=e.ref(null),r=e.ref([]),s=e.ref([]),c=e.ref(null),u=e.computed((()=>{var e;const t=(null==(e=r.value)?void 0:e[0])||null;return console.log("currentPet computed:",t),t})),g=e.computed((()=>{if(!u.value)return"";return[u.value.months?`${u.value.months}ä¸ªæœˆ`:"",u.value.weight?`${u.value.weight}kg`:""].filter(Boolean).join(" | ")})),v=e.computed((()=>{if(!u.value)return[];const e=u.value.temperament||"";return e?Array.isArray(e)?e:String(e).split(/[ï¼Œ,\s]+/).filter(Boolean).slice(0,3):[]}));function d(e){if(!e)return"";return[e.months?`${e.months}ä¸ªæœˆ`:"",e.weight?`${e.weight}kg`:""].filter(Boolean).join(" | ")}function p(e){if(!e)return[];const t=e.temperament||"";return t?Array.isArray(t)?t.slice(0,3):String(t).split(/[ï¼Œ,\s]+/).filter(Boolean).slice(0,3):[]}e.onMounted((async()=>{const t=n.initState();i.value=t.userInfo,t.isLoggedIn?(await m(),await w(),await y()):e.index.reLaunch({url:"/pages/login/login"})})),e.onShow((async()=>{await m(),await w(),await y()}));const h=new Map;function f(t){if(!t)return"/static/index/add.png";let n=t;return n.startsWith("/uploads/")&&(n=`https://pet-api.zbinli.cn${n}`),n.startsWith("http://pet-api.zbinli.cn")&&(n=n.replace("http://pet-api.zbinli.cn","https://pet-api.zbinli.cn")),n=n.replace("://pet-api.zbinli.cn:80","://pet-api.zbinli.cn"),n.startsWith("wxfile://")||n.startsWith("/static/")?n:h.has(n)?h.get(n):(e.index.downloadFile({url:n,success:e=>{200===e.statusCode&&e.tempFilePath?(h.set(n,e.tempFilePath),r.value=[...r.value]):(h.set(n,"/static/index/add.png"),r.value=[...r.value])},fail:()=>{h.set(n,"/static/index/add.png"),r.value=[...r.value]}}),"/static/index/add.png")}async function m(){var e,t;try{console.log("=== é¦–é¡µåŠ è½½å® ç‰©æ•°æ®è°ƒè¯•ä¿¡æ¯ ===");const n=await l.api.getPets();console.log("APIè¿”å›ç»“æœ:",n),r.value=Array.isArray(n)?n:n.data||[],console.log("å® ç‰©æ•°æ®:",r.value),console.log("ç¬¬ä¸€ä¸ªå® ç‰©çš„å¤´åƒURL:",null==(e=r.value[0])?void 0:e.avatarUrl),console.log("ç¬¬ä¸€ä¸ªå® ç‰©çš„å®Œæ•´æ•°æ®:",r.value[0]),a.value=r.value.length>0,console.log("æ˜¯å¦æœ‰å® ç‰©:",a.value),(null==(t=r.value[0])?void 0:t.avatarUrl)&&console.log("å¤´åƒURLè¯¦æƒ…:",{url:r.value[0].avatarUrl,type:typeof r.value[0].avatarUrl,length:r.value[0].avatarUrl.length})}catch(n){console.error("åŠ è½½å® ç‰©æ•°æ®å¤±è´¥:",n)}}async function w(){try{const e=new Date,t=new Date(e.getFullYear(),e.getMonth(),e.getDate(),0,0,0,0).toISOString(),n=new Date(e.getFullYear(),e.getMonth(),e.getDate(),23,59,59,999).toISOString(),o=await l.api.getSubscriptions({startDate:t,endDate:n}),a=Array.isArray(o)?o:o.subscriptions||o.data||[];s.value=a.map((e=>({id:e.id,title:e.content||("medicine"===e.type?"ç”¨è¯æé†’":"vaccine"===e.type?"ç–«è‹—æé†’":"wash"===e.type?"æ´—æŠ¤æé†’":"æ—¥å¸¸æé†’"),time:new Date(e.fireAt).toTimeString().slice(0,5)})))}catch(e){s.value=[]}}async function y(){try{console.log("ğŸ” å¼€å§‹åŠ è½½ä»Šæ—¥ç§‘æ™®...");const e=await l.api.getArticles({page:1,limit:200});console.log("ğŸ“¡ ç§‘æ™®APIè¿”å›:",e);const t=Array.isArray(e)?e:e.articles||e.data||[];if(console.log("ğŸ“‹ ç§‘æ™®æ–‡ç« åˆ—è¡¨:",t),!t.length)return console.log("âš ï¸ æ²¡æœ‰æ‰¾åˆ°ç§‘æ™®æ–‡ç« "),void(c.value=null);const n=t.slice().sort(((e,t)=>{const n=new Date(e.createdAt||0).getTime(),l=new Date(t.createdAt||0).getTime();return n!==l?n-l:String(e.id).localeCompare(String(t.id))})),o=new Date,a=new Date(o.getFullYear(),o.getMonth(),o.getDate()),i=Math.floor(a.getTime()/864e5),r=i%n.length;console.log("ğŸ“… æ—¶é—´è°ƒè¯•ä¿¡æ¯:"),console.log("  - å½“å‰æ—¶é—´:",o.toLocaleString()),console.log("  - æœ¬åœ°æ—¥æœŸ:",a.toLocaleString()),console.log("  - å¤©æ•°ç´¢å¼•:",i),console.log("  - ä»Šæ—¥ç´¢å¼•:",r,"æ€»æ–‡ç« æ•°:",n.length);const s=n[r];if(console.log("âœ… é€‰ä¸­çš„ç§‘æ™®æ–‡ç« :",s),s)if(s.content&&null!==s.content){const e=120,t=s.content;t.length>e&&(s.content=t.substring(0,e)+"...",console.log("âœ‚ï¸ å†…å®¹å·²æˆªæ–­:",s.content))}else s.content=s.title||"æš‚æ— å†…å®¹",console.log("âš ï¸ æ–‡ç« contentä¸ºnullï¼Œä½¿ç”¨titleä½œä¸ºå†…å®¹:",s.content);c.value=s,console.log("ğŸ¯ æœ€ç»ˆç§‘æ™®æ•°æ®:",c.value)}catch(e){console.error("âŒ åŠ è½½ä»Šæ—¥ç§‘æ™®å¤±è´¥:",e),c.value=null}}function D(){const e=(new Date).getHours();return e<12?"Good Morning!":e<18?"Good Afternoon!":"Good Evening!"}function A(){e.index.navigateTo({url:"/pages/createPet/createPet"})}function b(t){e.index.setStorageSync("recordTab",t),e.index.switchTab({url:"/pages/record/record"})}function S(e){console.log("å›¾ç‰‡åŠ è½½æˆåŠŸ:",e)}function x(e){var t;console.error("å›¾ç‰‡åŠ è½½å¤±è´¥:",e),console.error("å¤±è´¥çš„å›¾ç‰‡URL:",null==(t=u.value)?void 0:t.avatarUrl)}function U(t){if(t=t||u.value,console.log("=== é¦–é¡µè·³è½¬å® ç‰©è¯¦æƒ…è°ƒè¯•ä¿¡æ¯ ==="),console.log("å½“å‰å® ç‰©æ•°æ®:",t),console.log("å® ç‰©å¤´åƒURL:",null==t?void 0:t.avatarUrl),!t||!t.id)return;const n=encodeURIComponent(JSON.stringify(t));console.log("ç¼–ç åçš„æ•°æ®:",n),console.log("è·³è½¬URL:",`/pages/petDetail/petDetail?pet=${n}`),e.index.navigateTo({url:`/pages/petDetail/petDetail?pet=${n}`})}function _(){c.value&&c.value.id?(console.log("ğŸ” è·³è½¬ç§‘æ™®è¯¦æƒ…:",c.value),e.index.navigateTo({url:`/pages/scienceDetail/scienceDetail?id=${c.value.id}`,success:e=>{console.log("âœ… ç§‘æ™®è¯¦æƒ…é¡µè·³è½¬æˆåŠŸ");try{e.eventChannel.emit("science",c.value),console.log("ğŸ“¤ å·²å‘é€ç§‘æ™®æ•°æ®åˆ°è¯¦æƒ…é¡µ:",c.value)}catch(t){console.error("âŒ å‘é€ç§‘æ™®æ•°æ®å¤±è´¥:",t)}},fail:e=>{console.error("âŒ ç§‘æ™®è¯¦æƒ…é¡µè·³è½¬å¤±è´¥:",e)}})):console.log("âš ï¸ æ²¡æœ‰ç§‘æ™®å†…å®¹å¯è·³è½¬")}return(n,l)=>{var o,h,m,w,y;return e.e({a:e.t((null==(o=i.value)?void 0:o.nickname)||"ç”¨æˆ·"),b:e.t(D()),c:t._imports_0$2,d:a.value&&1===r.value.length},a.value&&1===r.value.length?e.e({e:f(null==(h=u.value)?void 0:h.avatarUrl),f:e.o(x),g:e.o(S),h:e.t((null==(m=u.value)?void 0:m.name)||"æˆ‘çš„å® ç‰©"),i:e.t(g.value),j:v.value.length},v.value.length?{k:e.f(v.value,((t,n,l)=>({a:e.t(t),b:n})))}:{},{l:e.o((e=>U(u.value)))}):a.value&&r.value.length>1?{n:e.f(r.value,((t,n,l)=>e.e({a:f(null==t?void 0:t.avatarUrl),b:e.t((null==t?void 0:t.name)||"æˆ‘çš„å® ç‰©"),c:e.t(d(t)),d:p(t).length},p(t).length?{e:e.f(p(t),((t,n,l)=>({a:e.t(t),b:n})))}:{},{f:t.id,g:e.o((e=>U(t)),t.id)})))}:{o:t._imports_0$1,p:e.o(A)},{m:a.value&&r.value.length>1,q:0===s.value.length},0===s.value.length?{}:{r:e.f(s.value,((t,n,l)=>({a:e.t(t.title),b:t.id})))},{s:t._imports_2,t:e.o((e=>b("calendar"))),v:t._imports_3,w:e.o((e=>b("stats"))),x:e.t((null==(w=c.value)?void 0:w.title)?`ã€${c.value.title}ã€‘`:"ã€ä»Šæ—¥å°çŸ¥è¯†ã€‘"),y:e.t((null==(y=c.value)?void 0:y.content)||"æ¯æ—¥ä¸ºä½ æ¨èä¸€æ¡å® ç‰©å¥åº·å°çŸ¥è¯†ï½"),z:t._imports_4,A:t._imports_5,B:e.o(_)})}}});wx.createPage(o);
