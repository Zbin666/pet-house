"use strict";const e=require("../../common/vendor.js"),t=require("../../common/assets.js"),a=require("../../utils/store.js"),i=require("../../utils/api.js"),n={__name:"user",setup(n){const s=e.ref("");e.onMounted((async()=>{try{const t=e.index.getSystemInfoSync(),a=t.statusBarHeight||0,i=t.screenWidth||375,n=e=>e*i/750,r=Math.round(n(120)+a);s.value=`padding-top:${r}px;`}catch(i){s.value=""}if(!a.checkAuth())return;const t=a.initState();r.value=t.userInfo,await x()})),e.onShow((async()=>{a.checkAuth()&&await x()}));const r=e.ref(null),l=e.ref([]),u=e.ref({feeds:0,likes:0}),c=e.ref(0),o=new Map,p=new Map,d=e.ref(!1);function v(t){if(!t)return"/static/user/user.png";let a=t;return a.startsWith("/uploads/")&&(a=`https://pet-api.zbinli.cn${a}`),a.startsWith("http://pet-api.zbinli.cn")&&(a=a.replace("http://pet-api.zbinli.cn","https://pet-api.zbinli.cn")),a=a.replace("://pet-api.zbinli.cn:80","://pet-api.zbinli.cn"),a.startsWith("wxfile://")||a.startsWith("/static/")?a:o.has(a)?o.get(a):(d.value=!0,e.index.downloadFile({url:a,success:e=>{d.value=!1,200===e.statusCode&&e.tempFilePath?(o.set(a,e.tempFilePath),r.value={...r.value||{}}):(o.set(a,"/static/user/user.png"),r.value={...r.value||{}})},fail:()=>{d.value=!1,o.set(a,"/static/user/user.png"),r.value={...r.value||{}}}}),"/static/user/user.png")}function h(e){try{e&&e.target&&(e.target.src="/static/user/user.png")}catch{}}function f(e){}function g(t){if(!t)return"/static/inedx/add.png";let a=t;return a.startsWith("/uploads/")&&(a=`https://pet-api.zbinli.cn${a}`),a.startsWith("http://pet-api.zbinli.cn")&&(a=a.replace("http://pet-api.zbinli.cn","https://pet-api.zbinli.cn")),a=a.replace("://pet-api.zbinli.cn:80","://pet-api.zbinli.cn"),a.startsWith("wxfile://")||a.startsWith("/static/")?a:p.has(a)?p.get(a):(e.index.downloadFile({url:a,success:e=>{200===e.statusCode&&e.tempFilePath?(p.set(a,e.tempFilePath),l.value=[...l.value]):(p.set(a,"/static/index/add.png"),l.value=[...l.value])},fail:()=>{p.set(a,"/static/index/add.png"),l.value=[...l.value]}}),"/static/index/add.png")}const m=e.ref("female"),w=e.computed((()=>"male"===m.value?"/static/user/male.png":"/static/user/female.png"));async function x(){var e;try{const t=await i.api.getProfile();t&&(r.value={...r.value,...t,avatarUrl:t.avatarUrl||(null==(e=r.value)?void 0:e.avatarUrl)});const a=await i.api.getPets();l.value=Array.isArray(a)?a:a.data||[];const n=await i.api.getUserStats();u.value.feeds=n.feeds||0,u.value.likes=n.likes||0,c.value=l.value.reduce(((e,t)=>{const a=t.startTogether||t.createdAt;if(!a)return e;const i=Math.max(1,Math.floor((Date.now()-new Date(a).getTime())/864e5));return Math.max(e,i)}),0)}catch(t){console.error("加载数据失败:",t)}}function _(){e.index.navigateTo({url:"/pages/createPet/createPet"})}function b(){e.index.navigateTo({url:"/pages/settings/setting"})}function z(){e.index.showModal({title:"退出登录",content:"确认退出当前账号吗？",success:e=>{e.confirm&&a.handleLogout()}})}function y(e){return[(null==e?void 0:e.months)?`${e.months}个月`:"",(null==e?void 0:e.weight)?`${e.weight}kg`:""].filter(Boolean).join(" | ")}return(a,i)=>{var n,o;return e.e({a:t._imports_0$8,b:v(null==(n=r.value)?void 0:n.avatarUrl),c:e.o(h),d:e.o(f),e:d.value},(d.value,{}),{f:e.t((null==(o=r.value)?void 0:o.nickname)||"用户"),g:w.value,h:e.t(u.value.feeds||0),i:e.t(u.value.likes||0),j:e.o(b),k:t._imports_1$3,l:e.t(c.value),m:e.f(l.value,((t,a,i)=>({a:g(t.avatarUrl),b:e.t(t.name),c:"male"===t.gender?"/static/user/male.png":"/static/user/female.png",d:e.t(y(t)),e:t.id,f:e.o((a=>function(t){const a=encodeURIComponent(JSON.stringify(t));e.index.navigateTo({url:`/pages/petDetail/petDetail?pet=${a}`})}(t)),t.id)}))),n:t._imports_2$1,o:e.o(_),p:t._imports_3$3,q:e.o(b),r:t._imports_3$3,s:e.o(z),t:e.s(s.value)})}}},s=e._export_sfc(n,[["__scopeId","data-v-42e56c70"]]);wx.createPage(s);
