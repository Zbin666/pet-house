"use strict";const e=require("../../common/vendor.js"),a=require("../../common/assets.js"),t=require("../../utils/api.js"),l=require("../../utils/upload.js"),i={__name:"petDetail",setup(i){const o=new Map,n=new Map,r=e.ref(0),s=e.ref({});function c(e){if(Array.isArray(e))return e;if("string"==typeof e){try{const a=JSON.parse(e);if(Array.isArray(a))return a}catch(a){}return e.split(",").map((e=>e.trim())).filter(Boolean)}return[]}function u(a){if(!a)return"/static/logo.png";let t=a;return t.startsWith("/uploads/")&&(t=`https://pet-api.zbinli.cn${t}`),t.startsWith("http://pet-api.zbinli.cn")&&(t=t.replace("http://pet-api.zbinli.cn","https://pet-api.zbinli.cn")),t=t.replace("://pet-api.zbinli.cn:80","://pet-api.zbinli.cn"),t.startsWith("wxfile://")||t.startsWith("/static/")?t:o.has(t)?o.get(t):(e.index.downloadFile({url:t,success:e=>{200===e.statusCode&&e.tempFilePath?(o.set(t,e.tempFilePath),s.value={...s.value||{}}):(o.set(t,"/static/logo.png"),s.value={...s.value||{}})},fail:()=>{o.set(t,"/static/logo.png"),s.value={...s.value||{}}}}),"/static/logo.png")}function v(a){if(!a)return"/static/index/add.png";let t=a;return t.startsWith("/uploads/")&&(t=`https://pet-api.zbinli.cn${t}`),t.startsWith("http://pet-api.zbinli.cn")&&(t=t.replace("http://pet-api.zbinli.cn","https://pet-api.zbinli.cn")),t=t.replace("://pet-api.zbinli.cn:80","://pet-api.zbinli.cn"),t.startsWith("wxfile://")||t.startsWith("/static/")?t:n.has(t)?n.get(t):(e.index.downloadFile({url:t,success:e=>{200===e.statusCode&&e.tempFilePath?(n.set(t,e.tempFilePath),r.value++):(console.warn("ç…§ç‰‡ä¸‹è½½å¤±è´¥:",t,e.statusCode),n.set(t,"/static/index/add.png"),r.value++)},fail:e=>{console.error("ç…§ç‰‡ä¸‹è½½å¤±è´¥:",t,e),n.set(t,"/static/index/add.png"),r.value++}}),"/static/index/add.png")}e.onLoad((async a=>{var l;if(e.index.setNavigationBarColor({frontColor:"#000000",backgroundColor:"#fff1a8"}),null==a?void 0:a.pet)try{const l=JSON.parse(decodeURIComponent(a.pet));if(Object.assign(s.value,l),d.value=c(l.vaccines),p.value=l.temperament||"",!l.vaccines||Array.isArray(l.vaccines)&&0===l.vaccines.length)try{const e=await t.api.getPet(s.value.id);d.value=c(e&&e.vaccines),p.value=e&&e.temperament||p.value}catch(i){}e.nextTick$1((()=>{})),console.log("èµ‹å€¼åŽçš„pet.value:",s.value)}catch(o){}if(null==(l=s.value)?void 0:l.id)try{const e=await t.api.getMedia({petId:s.value.id}),a=(Array.isArray(e)?e:e.media||e.data||[]).sort(((e,a)=>new Date(e.createdAt||e.created_at||0).getTime()-new Date(a.createdAt||a.created_at||0).getTime()));g.value=a.map((e=>e.url)).filter(Boolean)}catch(n){}})),e.ref([{id:"r1",time:"ä»Šå¤© 08:00",type:"å–‚é£Ÿ",desc:"çŒ«ç²® 60g"},{id:"r2",time:"æ˜¨å¤© 21:10",type:"æ¸…æ´",desc:"é“²ç ‚"}]);const d=e.ref([]),p=e.ref(""),g=e.ref([]),m=e.ref(!1),h=e.ref(["å¥³ç”Ÿ","ç”·ç”Ÿ"]),f=e.ref(1),y=e.ref(["å·²æŽ¥ç§çŒ«ä¸‰è”ç–«è‹—","å·²æŽ¥ç§çŒ«ä¸‰è”ç¬¬äºŒé’ˆ/åŠ å¼º","å·²æŽ¥ç§çŒ«ç™½è¡€ç—…ç–«è‹—(FeLV)","å·²æŽ¥ç§ç‹‚çŠ¬ç–«è‹—","å·²æŽ¥ç§çŠ¬äº”è”ç–«è‹—","å·²æŽ¥ç§çŠ¬å…­è”ç–«è‹—","å·²æŽ¥ç§çŠ¬ä¸ƒè”ç–«è‹—","å·²æŽ¥ç§å°çŠ¬ç»†å°ç–«è‹—","å·²æŽ¥ç§çŠ¬ç˜Ÿçƒ­ç–«è‹—","å·²æŽ¥ç§åšå¾·ç‰¹æ°æ”¯æ°”ç®¡ç‚Žç–«è‹—","å·²æŽ¥ç§é’©ç«¯èžºæ—‹ä½“ç–«è‹—","å·²æŽ¥ç§å…¶ä»–ç–«è‹—"]),w=e.reactive({name:"",months:"",weight:"",gender:"male",breed:"",color:"",neutered:!1,birthday:"",startTogether:"",avatar:"",vaccines:[],temperament:"",gallery:[]}),x=e.ref([]);function b(){m.value=!0,Object.assign(w,{...s.value,vaccines:[...d.value],temperament:p.value,avatarUrl:s.value.avatarUrl,gallery:[...g.value]}),x.value=[...g.value],f.value="male"===w.gender?1:0}function T(){m.value=!1,g.value=[...x.value]}async function _(){try{e.index.showLoading({title:"ä¿å­˜ä¸­..."});const o={name:w.name,months:w.months,weight:w.weight,gender:w.gender,breed:w.breed,color:w.color,neutered:w.neutered,birthday:w.birthday,startTogether:w.startTogether,temperament:w.temperament,vaccines:w.vaccines};if(w.avatar&&w.avatar.startsWith("wxfile://"))try{const{uploadImage:e,compressImage:a}=await"../../utils/upload.js",t=await a(w.avatar,.8),l=await e(t,"avatar");o.avatarUrl=l}catch(a){console.warn("å¤´åƒä¸Šä¼ å¤±è´¥:",a),e.index.showToast({title:"å¤´åƒä¸Šä¼ å¤±è´¥ï¼Œå…¶ä»–ä¿¡æ¯å·²ä¿å­˜",icon:"none"})}else w.avatarUrl&&(o.avatarUrl=w.avatarUrl);if(await t.api.updatePet(s.value.id,o),console.log("ðŸ” æ£€æŸ¥ç…§ç‰‡æ›´æ–°..."),console.log("form.gallery:",w.gallery),console.log("gallery.value:",g.value),w.gallery&&w.gallery.length>0){const o=w.gallery.filter((e=>e.startsWith("wxfile://")));if(console.log("æ–°ç…§ç‰‡æ•°é‡:",o.length),console.log("æ–°ç…§ç‰‡è·¯å¾„:",o),o.length>0)try{console.log("å¼€å§‹ä¸Šä¼ ç…§ç‰‡...");const e=o.map((async e=>{console.log("åŽ‹ç¼©ç…§ç‰‡:",e);const a=await l.compressImage(e,.7);console.log("åŽ‹ç¼©åŽè·¯å¾„:",a);const t=await l.uploadImage(a,"gallery");return console.log("ä¸Šä¼ æˆåŠŸï¼ŒURL:",t),t})),a=await Promise.all(e);console.log("æ‰€æœ‰ç…§ç‰‡ä¸Šä¼ å®Œæˆ:",a),console.log("åˆ›å»ºåª’ä½“è®°å½•..."),console.log("petId:",s.value.id),console.log("urls:",a);const n=await t.api.createMedia({petId:s.value.id,type:"image",urls:a,description:"å® ç‰©ç…§ç‰‡"});console.log("åª’ä½“è®°å½•åˆ›å»ºç»“æžœ:",n),console.log("æˆåŠŸä¸Šä¼ ç…§ç‰‡:",a.length,"å¼ ");try{const e=await t.api.getMedia({petId:s.value.id}),a=(Array.isArray(e)?e:e.media||e.data||[]).sort(((e,a)=>new Date(e.createdAt||e.created_at||0).getTime()-new Date(a.createdAt||a.created_at||0).getTime()));g.value=a.map((e=>e.url)).filter(Boolean),console.log("ä¿å­˜åŽé‡æ–°åŠ è½½ç…§ç‰‡ï¼ŒæŒ‰æ—¶é—´æŽ’åº:",a.map((e=>({url:e.url,createdAt:e.createdAt||e.created_at}))))}catch(i){console.warn("é‡æ–°åŠ è½½ç…§ç‰‡å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ›´æ–°:",i);const e=w.gallery.filter((e=>!e.startsWith("wxfile://")));g.value=[...e,...a]}}catch(a){console.error("ç…§ç‰‡ä¸Šä¼ å¤±è´¥:",a),e.index.showToast({title:"ç…§ç‰‡ä¸Šä¼ å¤±è´¥ï¼Œå…¶ä»–ä¿¡æ¯å·²ä¿å­˜",icon:"none"})}else console.log("æ²¡æœ‰æ–°ç…§ç‰‡éœ€è¦ä¸Šä¼ ")}else console.log("æ²¡æœ‰ç…§ç‰‡éœ€è¦å¤„ç†");s.value={...s.value,...o},d.value=[...w.vaccines],p.value=w.temperament,g.value=[...w.gallery],m.value=!1,e.index.hideLoading(),e.index.showToast({title:"ä¿å­˜æˆåŠŸ",icon:"success"})}catch(a){e.index.hideLoading(),console.error("ä¿å­˜å¤±è´¥:",a),e.index.showToast({title:"ä¿å­˜å¤±è´¥",icon:"none"})}}function A(e){f.value=Number(e.detail.value||0),w.gender=1===f.value?"male":"female"}function $(e){w.vaccines=e.detail.value||[]}function z(){e.index.chooseImage({count:9,sizeType:["compressed"],success:e=>{w.gallery=w.gallery.concat(e.tempFilePaths)}})}async function I(){e.index.showModal({title:"ç¡®è®¤åˆ é™¤",content:`ç¡®å®šè¦åˆ é™¤å® ç‰©"${s.value.name}"å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`,confirmText:"åˆ é™¤",cancelText:"å–æ¶ˆ",confirmColor:"#ff4757",success:async a=>{if(a.confirm)try{await t.api.deletePet(s.value.id),e.index.showToast({title:"å® ç‰©å·²åˆ é™¤",icon:"success"}),e.index.$emit&&e.index.$emit("pets:changed"),setTimeout((()=>{e.index.navigateBack()}),600)}catch(l){e.index.showToast({title:"åˆ é™¤å¤±è´¥",icon:"none"})}}})}function P(e){}function U(e){try{e&&e.target&&(e.target.src="/static/logo.png")}catch{}}return e.computed((()=>{const e=new Date(s.value.startTogether).getTime(),a=(new Date).setHours(0,0,0,0);return Math.max(1,Math.floor((a-e)/864e5)+1)})),(t,l)=>e.e({a:u(m.value&&w.avatarUrl?w.avatarUrl:s.value.avatarUrl),b:e.o(P),c:e.o(U),d:e.o((a=>m.value?void e.index.chooseImage({count:1,sizeType:["compressed"],success:e=>{w.avatar=e.tempFilePaths[0]}}):null)),e:!m.value},m.value?{g:w.name,h:e.o((e=>w.name=e.detail.value))}:{f:e.t(s.value.name)},{i:!m.value},m.value?{k:w.months,l:e.o(e.m((e=>w.months=e.detail.value),{number:!0}))}:{j:e.t(s.value.months||0)},{m:!m.value},m.value?{o:w.weight,p:e.o((e=>w.weight=e.detail.value))}:{n:e.t(s.value.weight||0)},{q:!m.value},m.value?{s:e.t(h.value[f.value]),t:h.value,v:f.value,w:e.o(A)}:{r:e.t("male"===s.value.gender?"ç”·ç”Ÿ":"å¥³ç”Ÿ")},{x:!m.value},m.value?{z:w.breed,A:e.o((e=>w.breed=e.detail.value))}:{y:e.t(s.value.breed)},{B:!m.value},m.value?{G:e.o(T),H:e.o(_)}:{C:a._imports_1$5,D:e.o(b),E:a._imports_0$4,F:e.o(I)},{I:a._imports_1$4,J:!m.value},m.value?{L:w.neutered,M:e.o((e=>w.neutered=e.detail.value))}:{K:e.t(s.value.neutered?"å·²ç»è‚²":"æœªç»è‚²")},{N:a._imports_1$4,O:!m.value},m.value?{Q:e.f(y.value,((a,t,l)=>({a:a,b:w.vaccines.includes(a),c:e.t(a),d:a}))),R:e.o($)}:{P:e.f(d.value,((a,t,l)=>({a:e.t(a),b:t})))},{S:a._imports_1$4,T:!m.value},m.value?{V:w.temperament,W:e.o((e=>w.temperament=e.detail.value))}:{U:e.t(p.value)},{X:a._imports_1$4,Y:e.f(m.value?w.gallery:g.value,((a,t,l)=>e.e({a:v(a),b:e.o((a=>function(a){const t=m.value?w.gallery:g.value;Array.isArray(t)&&0!==t.length&&e.index.previewImage({current:a,urls:t})}(t)),`photo-${t}-${r.value}`)},m.value?{c:e.o((a=>{return l=t,void(m.value&&e.index.showModal({title:"ç¡®è®¤åˆ é™¤",content:"ç¡®å®šè¦åˆ é™¤è¿™å¼ ç…§ç‰‡å—ï¼Ÿ",confirmText:"åˆ é™¤",cancelText:"å–æ¶ˆ",confirmColor:"#ff4757",success:e=>{e.confirm&&w.gallery.splice(l,1)}}));var l}),`photo-${t}-${r.value}`)}:{},{d:`photo-${t}-${r.value}`}))),Z:m.value,aa:m.value},m.value?{ab:e.o(z)}:{})}},o=e._export_sfc(i,[["__scopeId","data-v-93001d2b"]]);wx.createPage(o);
