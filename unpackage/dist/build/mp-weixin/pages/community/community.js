"use strict";const e=require("../../common/vendor.js"),t=require("../../common/assets.js"),a=require("../../utils/api.js"),s={__name:"community",setup(s){const n=e.ref("square"),i=e.ref(null),l=e.ref(""),o=e.ref(!1),r=e.ref("");e.onMounted((async()=>{try{const t=e.index.getSystemInfoSync(),a=t.statusBarHeight||0,s=(t.screenWidth,Math.round(.35*a));r.value=`padding-top:${s}px;`}catch(t){r.value=""}W.clear(),F.clear(),L.clear();try{const e=await a.api.getProfile();i.value=e}catch(t){console.error("èŽ·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:",t)}h(),w();try{e.index.$on("feeds:refresh",(()=>{"square"===n.value&&h()}))}catch(t){}try{e.index.$on("qa:refresh",(()=>{"qa"===n.value&&w()}))}catch(t){}})),e.onShow((()=>{"qa"===n.value?w():"square"===n.value?h():"science"===n.value&&U()}));const c=e.ref([{key:"rec",name:"æŽ¨è"},{key:"daily",name:"ç”Ÿæ´»æ—¥å¸¸"},{key:"dress",name:"å® ç‰©ç©¿æ­"},{key:"care",name:"å…»æŠ¤åˆ†äº«"},{key:"fun",name:"æžç¬‘æ—¥å¸¸"}]),u=e.ref("rec"),v=e.ref([]),d=e.ref(1),p=e.ref(10),g=e.ref(!0),f=e.ref(!1);async function h(e={},t=!1){if(!f.value)try{f.value=!0;const s=t?d.value:1,n=await a.api.getFeeds({page:s,limit:p.value,...e}),l=(Array.isArray(n)?n:n.feeds||n.data||[]).map((e=>{const t=e.User||{},a=e.Pet||{},s=Array.isArray(e.images)?e.images:[];let n="åˆšåˆš";e.createdAt&&(n=function(e){const t=new Date,a=e.split("T")[0],s=e.split("T")[1].split(".")[0],[n,i,l]=a.split("-").map(Number),[o,r]=s.split(":").map(Number),c=365*(t.getFullYear()-n)*24*60+30*(t.getMonth()+1-i)*24*60+24*(t.getDate()-l)*60+60*(t.getHours()-o)+(t.getMinutes()-r);if(c<1440)return c<1?"åˆšåˆš":c<60?`${c}åˆ†é’Ÿå‰`:`${Math.floor(c/60)}å°æ—¶å‰`;return`${i}/${l} ${o.toString().padStart(2,"0")}:${r.toString().padStart(2,"0")}`}(e.createdAt));let l="";if(e.tags&&Array.isArray(e.tags)&&e.tags.length>0)l=e.tags[0];else if(e.tags&&"string"==typeof e.tags)try{const t=JSON.parse(e.tags);Array.isArray(t)&&t.length>0&&(l=t[0])}catch(o){}return{id:e.id,userId:e.userId,user:t.nickname||"ç”¨æˆ·",pet:a.name||"",breed:a.breed||"",time:n,title:l?`#${l}`:"",text:e.text||"",avatar:t.avatarUrl||"/static/404.png",images:s,likes:e.likes||0,comments:"number"==typeof e.commentsCount?e.commentsCount:Array.isArray(e.Comments)?e.Comments.length:0,shares:e.shares||0,isOwner:i.value&&e.userId===i.value.id,isLiked:e.isLiked||!1}}));t?(v.value=[...v.value,...l],d.value++):(v.value=l,d.value=2),g.value=l.length>=p.value}catch(s){t||(v.value=[])}finally{f.value=!1}}async function m(){g.value&&!f.value&&await h({},!0)}async function w(e={},t=!1){if(!$.value)try{$.value=!0;const n=t?x.value:1,l=await a.api.getQuestions({page:n,limit:q.value,...e}),o=(Array.isArray(l)?l:l.questions||l.data||[]).map((e=>{var t,a;let s="åˆšåˆš";if(e.createdAt){const t=new Date(e.createdAt);s=`${t.getUTCMonth()+1}/${t.getUTCDate()} ${t.getUTCHours().toString().padStart(2,"0")}:${t.getUTCMinutes().toString().padStart(2,"0")}`}let n=[];if(e.tags)try{n="string"==typeof e.tags?JSON.parse(e.tags):e.tags,Array.isArray(n)||(n=[])}catch(l){n=[]}return{id:e.id,userId:(null==(t=e.user)?void 0:t.id)||e.userId,title:e.title,isUrgent:e.isUrgent,hasAnswer:e.answerCount>0,topAnswer:e.topAnswerId?{id:e.topAnswerId,content:e.topAnswerContent,likes:e.topAnswerLikes||0,isTopLiked:!0,user:e.topAnswerUserId?{id:e.topAnswerUserId,nickname:e.topAnswerUserNickname,avatarUrl:e.topAnswerUserAvatar}:null,pet:e.topAnswerPetName?{name:e.topAnswerPetName,breed:e.topAnswerPetBreed}:null}:null,answerCount:e.answerCount||0,readCount:e.views||0,time:s,tags:n,isOwner:i.value&&((null==(a=e.user)?void 0:a.id)||e.userId)===i.value.id}}));for(const e of o)if(!e.topAnswer)try{const t=await a.api.getQuestion(e.id);if(t&&Array.isArray(t.answers)&&t.answers.length>0){const a=[...t.answers].sort(((e,t)=>t.likes-e.likes||new Date(e.createdAt)-new Date(t.createdAt)))[0];e.topAnswer={id:a.id,content:a.content,likes:a.likes||0,isTopLiked:!0,user:a.user||null,pet:a.pet||null}}}catch(s){}t?(A.value=[...A.value,...o],x.value++):(A.value=o,x.value=2),k.value=o.length>=q.value,A.value=A.value.slice()}catch(n){console.error("åŠ è½½é—®ç­”æ•°æ®å¤±è´¥:",n),t||(A.value=[])}finally{$.value=!1}}async function y(){k.value&&!$.value&&await w({},!0)}const A=e.ref([]),x=e.ref(1),q=e.ref(10),k=e.ref(!0),$=e.ref(!1),C=e.ref([]),T=e.ref(1),b=e.ref(10),_=e.ref(!0),I=e.ref(!1);async function U(e={},t=!1){if(!I.value)try{I.value=!0,console.log("å¼€å§‹åŠ è½½ç§‘æ™®æ–‡ç« ï¼Œå‚æ•°:",e,"æ˜¯å¦åŠ è½½æ›´å¤š:",t);const s=t?T.value:1,n=await a.api.getArticles({page:s,limit:b.value,...e});console.log("APIè¿”å›žæ•°æ®:",n);const i=Array.isArray(n)?n:n.articles||n.data||[];console.log("å¤„ç†åŽçš„æ–‡ç« åˆ—è¡¨:",i);const l=i.map((e=>(console.log("å¤„ç†æ–‡ç« :",e.title,"å›¾ç‰‡URL:",e.cover),{id:e.id,title:e.title||"æ— æ ‡é¢˜",reads:e.reads||0,cover:e.cover||"/static/404.png",originalCover:e.cover})));t?(C.value=[...C.value,...l],T.value++):(C.value=l,T.value=2),_.value=l.length>=b.value,console.log("æœ€ç»ˆç§‘æ™®æ–‡ç« æ•°æ®:",C.value),console.log("å½“å‰é¡µæ•°:",T.value,"æ˜¯å¦è¿˜æœ‰æ›´å¤š:",_.value)}catch(s){console.error("åŠ è½½ç§‘æ™®æ–‡ç« å¤±è´¥:",s),t||(C.value=[])}finally{I.value=!1}}async function P(){_.value&&!I.value&&await U({},!0)}const L=new Map,F=new Map,W=new Map,z=e.ref(0),S=e.ref(0);function D(t){if(!t)return"/static/user/user.png";let a=t;return a.startsWith("/uploads/")&&(a=`https://pet-api.zbinli.cn${a}`),a.startsWith("http://pet-api.zbinli.cn")&&(a=a.replace("http://pet-api.zbinli.cn","https://pet-api.zbinli.cn")),a=a.replace("://pet-api.zbinli.cn:80","://pet-api.zbinli.cn"),a.startsWith("wxfile://")||a.startsWith("/static/")?a:F.has(a)?F.get(a):(e.index.downloadFile({url:a,success:e=>{200===e.statusCode&&e.tempFilePath?(F.set(a,e.tempFilePath),v.value=[...v.value],A.value=[...A.value],S.value++):(F.set(a,"/static/user/user.png"),v.value=[...v.value],A.value=[...A.value],S.value++)},fail:()=>{F.set(a,"/static/user/user.png"),v.value=[...v.value],A.value=[...A.value],S.value++}}),"/static/user/user.png")}function M(t){const a=t.originalCover;return a?a.startsWith("/static/")||a.startsWith("wxfile://")?a:L.has(a)?L.get(a):(e.index.downloadFile({url:a,success:e=>{200===e.statusCode&&e.tempFilePath?(L.set(a,e.tempFilePath),C.value=[...C.value]):(console.warn("å›¾ç‰‡ä¸‹è½½å¤±è´¥:",a,e.statusCode),L.set(a,"/static/404.png"),C.value=[...C.value])},fail:e=>{console.error("å›¾ç‰‡ä¸‹è½½å¤±è´¥:",a,e),L.set(a,"/static/404.png"),C.value=[...C.value]}}),"/static/404.png"):"/static/404.png"}function O(t){if(!t)return"/static/404.png";console.log("[å¹¿åœºå›¾ç‰‡] åŽŸå§‹URL:",t);let a=t;return a.startsWith("wxfile://")?(console.warn("[å¹¿åœºå›¾ç‰‡] å‘çŽ° wxfile:// æœ¬åœ°ä¸´æ—¶è·¯å¾„ï¼Œè¯¥è·¯å¾„å¯èƒ½å·²è¿‡æœŸ:",a),a):(a.startsWith("/uploads/")&&(a=`https://pet-api.zbinli.cn${a}`),a.startsWith("http://pet-api.zbinli.cn")&&(a=a.replace("http://pet-api.zbinli.cn","https://pet-api.zbinli.cn")),a=a.replace("://pet-api.zbinli.cn:80","://pet-api.zbinli.cn"),console.log("[å¹¿åœºå›¾ç‰‡] è§„èŒƒåŒ–åŽURL:",a),a.startsWith("wxfile://")||a.startsWith("/static/")?a:W.has(a)?(console.log("[å¹¿åœºå›¾ç‰‡] å‘½ä¸­ç¼“å­˜:",a),W.get(a)):(e.index.downloadFile({url:a,success:e=>{200===e.statusCode&&e.tempFilePath?(W.set(a,e.tempFilePath),z.value++,console.log("[å¹¿åœºå›¾ç‰‡] ä¸‹è½½æˆåŠŸï¼Œå·²ç¼“å­˜:",a,"->",e.tempFilePath)):(W.set(a,"/static/404.png"),z.value++,console.warn("[å¹¿åœºå›¾ç‰‡] ä¸‹è½½è¿”å›žå¼‚å¸¸ï¼Œä½¿ç”¨å ä½å›¾:",a,"status:",e.statusCode))},fail:()=>{W.set(a,"/static/404.png"),z.value++,console.error("[å¹¿åœºå›¾ç‰‡] ä¸‹è½½å¤±è´¥ï¼Œä½¿ç”¨å ä½å›¾:",a)}}),"/static/404.png"))}function N(e){console.error("å›¾ç‰‡åŠ è½½å¤±è´¥:",e),console.error("å›¾ç‰‡URL:",e.target.src),console.error("é”™è¯¯è¯¦æƒ…:",e.detail),e.target.src="/static/404.png",console.log("å·²è®¾ç½®é»˜è®¤å›¾ç‰‡:",e.target.src)}function j(e){console.log("å›¾ç‰‡åŠ è½½æˆåŠŸ:",e.target.src)}function R(e){n.value=e,"square"===e&&0===v.value.length?h():"qa"===e&&0===A.value.length?w():"science"===e&&0===C.value.length&&U()}function B(t){e.index.navigateTo({url:"/pages/questionDetail/questionDetail",success:e=>{try{e.eventChannel.emit("qa",t)}catch(a){}}})}function H(){e.index.navigateTo({url:"/pages/createCommunity/createCommunity"})}function Q(){}function J(){l.value.trim()&&(o.value=!0,"square"===n.value?h({search:l.value.trim()}):"qa"===n.value?w({search:l.value.trim()}):"science"===n.value&&U({search:l.value.trim()}))}let Y=null;function E(){Y&&clearTimeout(Y),Y=setTimeout((()=>{l.value.trim()?J():("square"===n.value?h():"qa"===n.value?w():"science"===n.value&&U(),o.value=!1)}),500)}function G(){l.value="",o.value=!1,"square"===n.value?h():"qa"===n.value?w():"science"===n.value&&U()}return(s,o)=>e.e({a:"square"===n.value},"square"===n.value?{b:t._imports_0$7}:{},{c:e.n("square"===n.value?"active":""),d:e.o((e=>R("square"))),e:"qa"===n.value},"qa"===n.value?{f:t._imports_0$7}:{},{g:e.n("qa"===n.value?"active":""),h:e.o((e=>R("qa"))),i:"science"===n.value},"science"===n.value?{j:t._imports_0$7}:{},{k:e.n("science"===n.value?"active":""),l:e.o((e=>R("science"))),m:t._imports_1$2,n:e.o(J),o:e.o([e=>l.value=e.detail.value,E]),p:l.value,q:l.value},l.value?{r:e.o(G)}:{},{s:"square"===n.value},"square"===n.value?{t:e.f(c.value,((t,a,s)=>({a:e.t(t.name),b:t.key,c:e.n(u.value===t.key?"on":""),d:e.o((e=>function(e){if(u.value=e,"square"===n.value){const t="rec"===e?void 0:e;h(t?{category:t}:{})}}(t.key)),t.key)})))}:{},{v:"square"===n.value},"square"===n.value?e.e({w:e.f(v.value,((s,n,l)=>e.e({a:D(s.avatar),b:e.t(s.user),c:e.t(s.pet),d:e.t(s.breed),e:e.t(s.time),f:s.title},s.title?{g:e.t(s.title)}:{},{h:e.t(s.text),i:s.images&&s.images.length},s.images&&s.images.length?{j:e.f(s.images,((t,a,n)=>({a:`${z.value}-${a}`,b:O(t),c:e.o((t=>function(t,a){if(t&&0!==t.length){try{console.log("[å›¾ç‰‡é¢„è§ˆ] å½“å‰ç´¢å¼•:",a),console.log("[å›¾ç‰‡é¢„è§ˆ] åŽŸå§‹åˆ—è¡¨:",t),t.some((e=>"string"==typeof e&&e.startsWith("wxfile://")))&&(console.warn("[å›¾ç‰‡é¢„è§ˆ] åˆ—è¡¨åŒ…å« wxfile:// è·¯å¾„ï¼Œè¿™ç±»è·¯å¾„å¯èƒ½å·²è¿‡æœŸï¼Œæ— æ³•åœ¨æ–°ä¼šè¯ä¸­è®¿é—®"),e.index.showToast({title:"æœ‰æœ¬åœ°ä¸´æ—¶å›¾ç‰‡å¯èƒ½å·²è¿‡æœŸ",icon:"none"}))}catch(s){}e.index.previewImage({current:a,urls:t,success:()=>{console.log("å›¾ç‰‡é¢„è§ˆæˆåŠŸ")},fail:a=>{console.error("å›¾ç‰‡é¢„è§ˆå¤±è´¥:",a,"urls:",t),e.index.showToast({title:"å›¾ç‰‡é¢„è§ˆå¤±è´¥",icon:"none"})}})}}(s.images,a)),`${z.value}-${a}`),d:e.o((e=>function(e,t,a){try{console.error("[å¹¿åœºå›¾ç‰‡] åŠ è½½å¤±è´¥:",{postId:a,index:t,url:e}),"string"==typeof e&&e.startsWith("wxfile://")&&console.warn("[å¹¿åœºå›¾ç‰‡] å¤±è´¥å¯èƒ½åŽŸå› ï¼šwxfile:// æœ¬åœ°ä¸´æ—¶è·¯å¾„å·²è¿‡æœŸ")}catch(s){}}(t,a,s.id)),`${z.value}-${a}`)})))}:{},{k:e.t(s.shares),l:e.t(s.comments),m:s.isLiked?"/static/community/good-active.png":"/static/community/good.png",n:e.t(s.likes),o:e.o((t=>async function(t){if(i.value)try{const s=await a.api.likeFeed(t.id);s&&(t.likes=s.likes,t.isLiked=s.isLiked,e.index.showToast({title:t.isLiked?"å·²ç‚¹èµž":"å·²å–æ¶ˆç‚¹èµž",icon:"none",duration:1e3}))}catch(s){console.error("ç‚¹èµžæ“ä½œå¤±è´¥:",s),e.index.showToast({title:"æ“ä½œå¤±è´¥",icon:"none"})}else e.index.showToast({title:"è¯·å…ˆç™»å½•",icon:"none"})}(s)),s.id),p:s.isOwner},s.isOwner?{q:t._imports_0$4,r:e.o((t=>async function(t){try{e.index.showModal({title:"ç¡®è®¤åˆ é™¤",content:"ç¡®å®šè¦åˆ é™¤è¿™æ¡åŠ¨æ€å—ï¼Ÿåˆ é™¤åŽæ— æ³•æ¢å¤ã€‚",confirmText:"åˆ é™¤",cancelText:"å–æ¶ˆ",confirmColor:"#ff4757",success:async s=>{if(s.confirm)try{await a.api.deleteFeed(t.id),e.index.showToast({title:"åˆ é™¤æˆåŠŸ",icon:"success"});const s=v.value.findIndex((e=>e.id===t.id));s>-1&&v.value.splice(s,1)}catch(n){console.error("åˆ é™¤åŠ¨æ€å¤±è´¥:",n),e.index.showToast({title:"åˆ é™¤å¤±è´¥",icon:"none"})}}})}catch(s){console.error("åˆ é™¤åŠ¨æ€å¤±è´¥:",s),e.index.showToast({title:"åˆ é™¤å¤±è´¥",icon:"none"})}}(s)),s.id)}:{},{s:e.o(Q,s.id),t:s.id,v:e.o((t=>function(t){e.index.navigateTo({url:`/pages/communityDetail/communityDetail?id=${t.id}`,success:e=>{try{e.eventChannel.emit("post",t)}catch(a){}}})}(s)),s.id)}))),x:t._imports_0$6,y:t._imports_1$1,z:v.value.length>0},v.value.length>0?e.e({A:f.value},f.value?{}:g.value?{C:e.o(m)}:{},{B:!g.value}):{},{D:e.o(m),E:f.value,F:e.o((()=>h()))}):{},{G:"science"===n.value},"science"===n.value?e.e({H:e.f(C.value,((t,s,n)=>({a:M(t),b:e.o(N,t.id),c:e.o(j,t.id),d:e.t(t.title),e:e.t(t.reads),f:t.id,g:e.o((s=>async function(t){try{console.log("ðŸ” ç‚¹å‡»ç§‘æ™®æ–‡ç« :",t),console.log("ðŸ” å½“å‰é˜…è¯»æ•°:",t.reads),console.log("ðŸ“¡ å¼€å§‹è°ƒç”¨å¢žåŠ é˜…è¯»æ•°API...");const e=await a.api.incrementArticleReads(t.id);if(console.log("ðŸ“¡ APIè¿”å›žç»“æžœ:",e),e&&e.success){console.log("âœ… é˜…è¯»æ•°å¢žåŠ æˆåŠŸï¼Œæ–°é˜…è¯»æ•°:",e.reads);const a=C.value.findIndex((e=>e.id===t.id));console.log("ðŸ” æ‰¾åˆ°æ–‡ç« ç´¢å¼•:",a),a>-1&&(console.log("ðŸ”„ æ›´æ–°å‰æœ¬åœ°é˜…è¯»æ•°:",C.value[a].reads),C.value[a].reads=e.reads,console.log("ðŸ”„ æ›´æ–°åŽæœ¬åœ°é˜…è¯»æ•°:",C.value[a].reads)),t.reads=e.reads,console.log("ðŸ”„ æ›´æ–°ä¼ å…¥è¯¦æƒ…é¡µçš„é˜…è¯»æ•°:",t.reads)}else console.warn("âš ï¸ APIè¿”å›žå¤±è´¥æˆ–æ ¼å¼ä¸æ­£ç¡®:",e)}catch(s){console.error("âŒ å¢žåŠ é˜…è¯»æ•°å¤±è´¥:",s)}console.log("ðŸš€ å‡†å¤‡è·³è½¬åˆ°è¯¦æƒ…é¡µï¼Œæ–‡ç« æ•°æ®:",t),e.index.navigateTo({url:`/pages/scienceDetail/scienceDetail?id=${t.id}`,success:e=>{console.log("âœ… é¡µé¢è·³è½¬æˆåŠŸ");try{e.eventChannel.emit("science",t),console.log("ðŸ“¤ å·²å‘é€æ–‡ç« æ•°æ®åˆ°è¯¦æƒ…é¡µ:",t)}catch(a){console.error("âŒ å‘é€æ•°æ®åˆ°è¯¦æƒ…é¡µå¤±è´¥:",a)}},fail:e=>{console.error("âŒ é¡µé¢è·³è½¬å¤±è´¥:",e)}})}(t)),t.id)}))),I:C.value.length>0},C.value.length>0?e.e({J:I.value},I.value?{}:_.value?{L:e.o(P)}:{},{K:!_.value}):{},{M:e.o(P),N:I.value,O:e.o((()=>U()))}):{},{P:"qa"===n.value},"qa"===n.value?e.e({Q:e.f(A.value,((s,n,i)=>e.e({a:s.isOwner},s.isOwner?{b:t._imports_0$4,c:e.o((t=>async function(t){try{e.index.showModal({title:"ç¡®è®¤åˆ é™¤",content:"ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé—®ç­”å—ï¼Ÿåˆ é™¤åŽæ— æ³•æ¢å¤ã€‚",confirmText:"åˆ é™¤",cancelText:"å–æ¶ˆ",confirmColor:"#ff4757",success:async s=>{if(s.confirm)try{await a.api.deleteQuestion(t.id),e.index.showToast({title:"åˆ é™¤æˆåŠŸ",icon:"success"});const s=A.value.findIndex((e=>e.id===t.id));s>-1&&A.value.splice(s,1)}catch(n){console.error("åˆ é™¤é—®ç­”å¤±è´¥:",n),e.index.showToast({title:"åˆ é™¤å¤±è´¥",icon:"none"})}}})}catch(s){console.error("åˆ é™¤é—®ç­”å¤±è´¥:",s),e.index.showToast({title:"åˆ é™¤å¤±è´¥",icon:"none"})}}(s)),s.id)}:{},{d:s.isUrgent},(s.isUrgent,{}),{e:e.t(s.title),f:s.tags&&s.tags.length>0},s.tags&&s.tags.length>0?{g:e.f(s.tags,((t,a,s)=>({a:e.t(t),b:t})))}:{},{h:s.hasAnswer&&s.topAnswer},s.hasAnswer&&s.topAnswer?e.e({i:D(s.topAnswer.user.avatarUrl),j:`qa-avatar-${S.value}-${s.topAnswer.user.id||s.id}`,k:e.t(s.topAnswer.user.nickname),l:s.topAnswer.pet},s.topAnswer.pet?{m:e.t(s.topAnswer.pet.name),n:e.t(s.topAnswer.pet.breed)}:{},{o:s.topAnswer.isTopLiked},s.topAnswer.isTopLiked?{p:t._imports_5$1,q:e.t(s.topAnswer.likes)}:{},{r:e.t(s.topAnswer.content.length>50?s.topAnswer.content.substring(0,50)+"...":s.topAnswer.content),s:e.t(s.answerCount),t:e.o((e=>B(s)),s.id),v:`qa-content-${S.value}-${s.id}`}):s.hasAnswer?{x:e.t(s.answerCount),y:e.o((e=>B(s)),s.id)}:{},{w:s.hasAnswer,z:e.t(s.answerCount),A:e.t(s.readCount),B:s.id,C:e.o((e=>B(s)),s.id)}))),R:A.value.length>0},A.value.length>0?e.e({S:$.value},$.value?{}:k.value?{U:e.o(y)}:{},{T:!k.value}):{},{V:e.o(y),W:$.value,X:e.o((()=>w()))}):{},{Y:"science"!==n.value},"science"!==n.value?{Z:t._imports_3$1,aa:e.o(H)}:{},{ab:e.s(r.value)})}},n=e._export_sfc(s,[["__scopeId","data-v-a8164ce6"]]);wx.createPage(n);
