"use strict";const e=require("../../common/vendor.js"),t=require("../../common/assets.js"),a=require("../../utils/api.js"),i=require("../../utils/upload.js"),n=e.defineComponent({__name:"createPet",setup(n){const o=new Map,s=e.ref(0),r=new Map,l=e.ref(0);function c(t){if(!t)return"/static/index/add.png";let a=t;return a.startsWith("/uploads/")&&(a=`https://pet-api.zbinli.cn${a}`),a.startsWith("http://pet-api.zbinli.cn")&&(a=a.replace("http://pet-api.zbinli.cn","https://pet-api.zbinli.cn")),a=a.replace("://pet-api.zbinli.cn:80","://pet-api.zbinli.cn"),a.startsWith("wxfile://")||a.startsWith("/static/")?a:o.has(a)?o.get(a):(e.index.downloadFile({url:a,success:e=>{200===e.statusCode&&e.tempFilePath?(o.set(a,e.tempFilePath),s.value++):(console.warn("头像下载失败:",a,e.statusCode),o.set(a,"/static/index/add.png"),s.value++)},fail:e=>{console.error("头像下载失败:",a,e),o.set(a,"/static/index/add.png"),s.value++}}),"/static/index/add.png")}function d(t){if(!t)return"/static/index/add.png";let a=t;return a.startsWith("/uploads/")&&(a=`https://pet-api.zbinli.cn${a}`),a.startsWith("http://pet-api.zbinli.cn")&&(a=a.replace("http://pet-api.zbinli.cn","https://pet-api.zbinli.cn")),a=a.replace("://pet-api.zbinli.cn:80","://pet-api.zbinli.cn"),a.startsWith("wxfile://")||a.startsWith("/static/")?a:r.has(a)?r.get(a):(e.index.downloadFile({url:a,success:e=>{200===e.statusCode&&e.tempFilePath?(r.set(a,e.tempFilePath),l.value++):(console.warn("照片下载失败:",a,e.statusCode),r.set(a,"/static/index/add.png"),l.value++)},fail:e=>{console.error("照片下载失败:",a,e),r.set(a,"/static/index/add.png"),l.value++}}),"/static/index/add.png")}const p=e.reactive({name:"",months:"",weight:"",gender:"female",breed:"",color:"",birthday:"",startTogether:"",neutered:!1,vaccines:[],temperament:"",avatar:"",gallery:[]}),u=e.ref(["女生","男生"]),h=e.ref(0),m=e.ref(["已接种猫三联疫苗","已接种猫三联第二针/加强","已接种猫白血病疫苗(FeLV)","已接种狂犬疫苗","已接种犬五联疫苗","已接种犬六联疫苗","已接种犬七联疫苗","已接种小犬细小疫苗","已接种犬瘟热疫苗","已接种博德特氏支气管炎疫苗","已接种钩端螺旋体疫苗","已接种其他疫苗"]);function g(e){h.value=Number(e.detail.value),p.gender=1===h.value?"male":"female"}function v(e){p.birthday=e.detail.value}function f(e){p.startTogether=e.detail.value}function x(e){p.vaccines=e.detail.value||[]}async function w(){try{const t=await e.index.chooseImage({count:1,sizeType:["compressed"],sourceType:["album","camera"]}),a=await i.compressImage(t.tempFilePaths[0],.8);e.index.showLoading({title:"上传头像中..."});const n=await i.uploadImage(a,"avatar");p.avatar=n,e.index.hideLoading(),e.index.showToast({title:"头像上传成功",icon:"success"})}catch(t){e.index.hideLoading(),console.error("选择头像失败:",t),e.index.showToast({title:"头像上传失败",icon:"none"})}}async function b(){const t=9-p.gallery.length;if(t<=0)e.index.showToast({title:"最多只能上传9张照片",icon:"none"});else try{const a=await e.index.chooseImage({count:t,sizeType:["compressed"],sourceType:["album","camera"]});e.index.showLoading({title:"上传照片中..."});const n=a.tempFilePaths.map((async e=>{const t=await i.compressImage(e,.7);return await i.uploadImage(t,"gallery")})),o=await Promise.all(n);p.gallery=p.gallery.concat(o),e.index.hideLoading(),e.index.showToast({title:`成功上传${o.length}张照片`,icon:"success"})}catch(a){e.index.hideLoading(),console.error("选择照片失败:",a),e.index.showToast({title:"照片上传失败",icon:"none"})}}async function y(){if(p.name.trim()||(e.index.showToast({title:"请输入宠物昵称",icon:"none"}),0))try{e.index.showLoading({title:"保存中..."});const i={name:p.name,gender:p.gender,breed:p.breed||"",neutered:!!p.neutered};p.birthday&&(i.birthday=p.birthday),p.startTogether&&(i.startTogether=p.startTogether),p.months&&(i.months=parseInt(p.months)),p.weight&&(i.weight=parseFloat(p.weight)),p.color&&(i.color=p.color),p.temperament&&(i.temperament=p.temperament),p.vaccines&&p.vaccines.length>0&&(i.vaccines=p.vaccines),p.avatar&&(i.avatarUrl=p.avatar),console.log("提交宠物数据:",i);const n=await a.api.createPet(i);if(console.log("宠物创建成功:",n),p.gallery&&p.gallery.length>0){const e=p.gallery.filter((e=>e&&e.trim()));if(e.length>0)try{await a.api.createMedia({petId:n.id,type:"image",urls:e,description:"宠物照片"}),console.log("成功创建媒体记录:",e.length,"张照片")}catch(t){console.warn("照片上传失败，但宠物已创建:",t)}else console.log("没有照片，跳过媒体记录创建")}e.index.hideLoading(),e.index.showToast({title:"宠物创建成功",icon:"success"}),setTimeout((()=>{e.index.navigateBack()}),800)}catch(i){e.index.hideLoading(),console.error("创建宠物失败:",i);let t="创建失败";i.message&&(t=i.message.includes("Unauthorized")?"登录已过期，请重新登录":i.message.includes("Network")?"网络连接失败，请检查网络":`创建失败: ${i.message}`),e.index.showToast({title:t,icon:"none"})}}function T(){e.index.showModal({title:"确认取消",content:"确定要取消创建宠物吗？已填写的信息将丢失。",confirmText:"确定",cancelText:"继续编辑",confirmColor:"#ff4757",success:t=>{t.confirm&&e.index.navigateBack()}})}return e.onLoad((()=>{e.index.setNavigationBarColor({frontColor:"#000000",backgroundColor:"#fff1a8"})})),(a,i)=>e.e({a:p.avatar},p.avatar?{b:c(p.avatar),c:`avatar-${s.value}`}:{d:t._imports_0$1},{e:e.o(w),f:p.name,g:e.o((e=>p.name=e.detail.value)),h:p.months,i:e.o(e.m((e=>p.months=e.detail.value),{number:!0})),j:p.weight,k:e.o((e=>p.weight=e.detail.value)),l:e.t(u.value[h.value]),m:u.value,n:h.value,o:e.o(g),p:p.breed,q:e.o((e=>p.breed=e.detail.value)),r:p.color,s:e.o((e=>p.color=e.detail.value)),t:e.t(p.birthday||"选择生日"),v:p.birthday,w:e.o(v),x:e.t(p.startTogether||"选择日期"),y:p.startTogether,z:e.o(f),A:t._imports_1$4,B:p.neutered,C:e.o((e=>p.neutered=e.detail.value)),D:e.f(m.value,((t,a,i)=>({a:t,b:p.vaccines.includes(t),c:e.t(t),d:t}))),E:e.o(x),F:p.temperament,G:e.o((e=>p.temperament=e.detail.value)),H:t._imports_1$4,I:e.f(p.gallery,((t,a,i)=>({a:d(t),b:e.o((t=>function(t){e.index.showModal({title:"确认删除",content:"确定要删除这张照片吗？",confirmText:"删除",cancelText:"取消",confirmColor:"#ff4757",success:e=>{e.confirm&&p.gallery.splice(t,1)}})}(a)),`photo-${a}-${l.value}`),c:`photo-${a}-${l.value}`}))),J:t._imports_0$1,K:e.o(b),L:e.o(T),M:e.o(y)})}}),o=e._export_sfc(n,[["__scopeId","data-v-858f4c9d"]]);wx.createPage(o);
