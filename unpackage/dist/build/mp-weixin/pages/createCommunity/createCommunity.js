"use strict";const e=require("../../common/vendor.js"),t=require("../../utils/api.js"),a=require("../../utils/upload.js"),i={__name:"createCommunity",setup(i){const l=new Map;function u(t){if(!t)return"/static/user/user.png";let a=t;return a.startsWith("/uploads/")&&(a=`https://pet-api.zbinli.cn${a}`),a.startsWith("http://pet-api.zbinli.cn")&&(a=a.replace("http://pet-api.zbinli.cn","https://pet-api.zbinli.cn")),a=a.replace("://pet-api.zbinli.cn:80","://pet-api.zbinli.cn"),a.startsWith("wxfile://")||a.startsWith("/static/")?a:l.has(a)?l.get(a):(e.index.downloadFile({url:a,success:e=>{200===e.statusCode&&e.tempFilePath?(l.set(a,e.tempFilePath),c.value={...c.value}):(l.set(a,"/static/user/user.png"),c.value={...c.value})},fail:()=>{l.set(a,"/static/user/user.png"),c.value={...c.value}}}),"/static/user/user.png")}const n=e.ref(""),s=e.ref([]),o=e.ref([]),r=e.ref("");e.ref("");const c=e.ref({}),v=e.ref({}),p=e.ref(!1),d=e.ref(""),h=e.ref(!1);async function f(){if(p.value){if(!d.value.trim()||!n.value.trim())return void e.index.showToast({title:"请输入问题标题和内容",icon:"none"});try{const a={title:d.value.trim(),content:n.value.trim(),isUrgent:h.value,tags:o.value,petId:v.value.id};await t.api.createQuestion(a),e.index.showToast({title:"问题发布成功",icon:"success"}),setTimeout((()=>{e.index.navigateBack();try{e.index.$emit("questions:refresh")}catch(t){}}),800)}catch(i){console.error("发布问答失败:",i),e.index.showToast({title:i.message||"发布失败，请检查网络连接",icon:"none",duration:3e3})}}else{if(!n.value.trim()&&0===s.value.length)return void e.index.showToast({title:"请输入内容或添加图片",icon:"none"});try{const l=s.value.filter((e=>"string"==typeof e&&e.startsWith("wxfile://")));let u=[];l.length>0&&(e.index.showLoading({title:`上传${l.length}张图片中...`}),u=await a.uploadImages(l,"gallery",v.value.id));const r=[];let c=0;for(const e of s.value)"string"==typeof e&&e.startsWith("wxfile://")?(r.push(u[c]),c++):r.push(e);s.value=r,e.index.hideLoading();const p={text:n.value.trim(),images:s.value,tags:o.value,petId:v.value.id};await t.api.createFeed(p),e.index.showToast({title:"发布成功",icon:"success"}),setTimeout((()=>{e.index.navigateBack();try{e.index.$emit("feeds:refresh")}catch(i){}}),800)}catch(i){e.index.hideLoading(),console.error("发布动态失败:",i),e.index.showToast({title:i.message||"发布失败，请检查网络连接",icon:"none",duration:3e3})}}}function g(){e.index.chooseImage({count:9-s.value.length,sizeType:["compressed"],sourceType:["album","camera"],success:e=>{s.value.push(...e.tempFilePaths)}})}function m(){const e=r.value.trim().replace(/^#+/,"");e&&!o.value.includes(e)&&(o.value.push(e),r.value="")}return e.onMounted((()=>{!async function(){try{const e=await t.api.getProfile();c.value=e;const a=await t.api.getPets();a&&a.length>0&&(v.value=a[0])}catch(e){console.warn("Failed to load user/pet info:",e)}}()})),(t,a)=>e.e({a:e.n(p.value?"":"active"),b:e.o((e=>p.value=!1)),c:e.n(p.value?"active":""),d:e.o((e=>p.value=!0)),e:u(c.value.avatarUrl),f:e.t(c.value.nickname||"用户"),g:e.t(v.value.name||"未设置宠物"),h:e.t(v.value.breed?"｜"+v.value.breed:""),i:p.value},p.value?{j:d.value,k:e.o((e=>d.value=e.detail.value)),l:e.t(d.value.length)}:{},{m:p.value?"详细描述你的问题...":"分享你的宠物日常...",n:n.value,o:e.o((e=>n.value=e.detail.value)),p:e.t(n.value.length),q:!p.value},p.value?{}:e.e({r:e.f(s.value,((t,a,i)=>({a:t,b:e.o((e=>function(e){s.value.splice(e,1)}(a)),a),c:a}))),s:s.value.length<9},s.value.length<9?{t:e.o(g)}:{}),{v:o.value.length>0},o.value.length>0?{w:e.f(o.value,((t,a,i)=>({a:e.t(t),b:e.o((e=>function(e){o.value.splice(e,1)}(a)),a),c:a})))}:{},{x:e.o(m),y:r.value,z:e.o((e=>r.value=e.detail.value)),A:p.value},p.value?e.e({B:h.value},(h.value,{}),{C:e.n(h.value?"checked":""),D:e.o((e=>h.value=!h.value))}):{},{E:e.t(p.value?"发布问题":"发布"),F:e.o(f)})}},l=e._export_sfc(i,[["__scopeId","data-v-afe56f48"]]);wx.createPage(l);
