"use strict";const e=require("../../common/vendor.js"),a=require("../../common/assets.js"),t=require("../../utils/upload.js"),o=require("../../utils/api.js"),i={__name:"recordDetail",setup(i){const n={eating:{key:"eating",title:"饮食",icon:"/static/record/eating.png"},drinking:{key:"drinking",title:"饮水",icon:"/static/record/drinking.png"},weight:{key:"weight",title:"体重",icon:"/static/record/weight.png"},washing:{key:"washing",title:"洗护",icon:"/static/record/washing.png"},shit:{key:"shit",title:"便便",icon:"/static/record/shit.png"},noting:{key:"noting",title:"记事",icon:"/static/record/noting.png"},abnormal:{key:"abnormal",title:"异常",icon:"/static/record/abnormal.png"},medicine:{key:"medicine",title:"用药",icon:"/static/record/medicine.png"}},l=e.ref({}),u=e.ref("eating"),d=e.ref({}),s=e.ref(!1),v=e.reactive({}),r=e.ref(!1),c=e.reactive({}),p=e.ref([]),h=e.ref([]),g=e.ref(!1),m=e.ref(0),y=e.ref([]),f=e.ref(0),w=e.ref(0),b=e.ref(!0),k=new Map,T=new Map,x=e.ref(0),$=[{top:"/static/record/cat.png",bottom:"/static/record/gray-cat.png"},{top:"/static/record/up-cat_2.png",bottom:"/static/record/bottom-cat_2.png"},{top:"/static/record/up-dog_1.png",bottom:"/static/record/bottom-dog_1.png"}];function _(e){return $[e%$.length].top}function N(e){return $[e%$.length].bottom}function S(e){return"/static/record/bottom-dog_1.png"===$[e%$.length].bottom}function A(e){return"/static/record/up-dog_1.png"===$[e%$.length].top}function I(a){return a?a.startsWith("/static/")||a.startsWith("wxfile://")?a:k.has(a)?k.get(a):(e.index.downloadFile({url:a,success:e=>{200===e.statusCode&&e.tempFilePath?(k.set(a,e.tempFilePath),y.value=[...y.value],p.value=[...p.value]):(console.warn("宠物头像下载失败:",a,e.statusCode),k.set(a,"/static/index/add.png"),y.value=[...y.value],p.value=[...p.value])},fail:e=>{console.error("宠物头像下载失败:",a,e),k.set(a,"/static/index/add.png"),y.value=[...y.value],p.value=[...p.value]}}),"/static/index/add.png"):"/static/index/add.png"}function C(a){if(!a)return"/static/index/add.png";if(a.startsWith("/static/")||a.startsWith("wxfile://"))return a;if(T.has(a))return T.get(a);let t=a;return t.startsWith("/uploads/")&&(t=`https://pet-api.zbinli.cn${t}`),t.startsWith("http://pet-api.zbinli.cn")&&(t=t.replace("http://pet-api.zbinli.cn","https://pet-api.zbinli.cn")),t=t.replace("://pet-api.zbinli.cn:80","://pet-api.zbinli.cn"),e.index.downloadFile({url:t,success:e=>{200===e.statusCode&&e.tempFilePath?(T.set(a,e.tempFilePath),x.value++):(console.warn("照片下载失败:",a,e.statusCode),T.set(a,"/static/index/add.png"),x.value++)},fail:e=>{console.error("照片下载失败:",a,e),T.set(a,"/static/index/add.png"),x.value++}}),"/static/index/add.png"}e.onLoad((async a=>{e.index.setNavigationBarTitle({title:"记录详情"}),e.index.setNavigationBarColor({frontColor:"#000000",backgroundColor:"#fff1a8"}),await async function(){try{const e=await o.api.getPets(),a=Array.isArray(e)?e:e.data||[];p.value=a.map((e=>({id:e.id,name:e.name,avatar:e.avatarUrl||"/static/index/add.png",avatarUrl:e.avatarUrl})))}catch(e){p.value=[]}}(),await M(a)})),e.onShow((async()=>{if(k.clear(),T.clear(),0===y.value.length){const e=u.value;await M({type:e},!1)}}));const D=async()=>{var e,a;const t=y.value.length>0?null==(a=null==(e=y.value[m.value])?void 0:e.type)?void 0:a.key:u.value;await M({type:t},!1)};async function M(e,a=!0){const t=e.type||"eating";u.value=t;const i={eating:"feed",drinking:"water",weight:"weight",washing:"clean",noting:"diary",shit:"diary",abnormal:"diary",medicine:"medicine"}[t]||"diary";a&&(b.value=!0);try{const s={type:i,page:1,limit:20};e.startDate&&e.endDate&&(s.startDate=e.startDate,s.endDate=e.endDate);const v=await o.api.getRecords(s);let r=(Array.isArray(v)?v:v.records||v.data||v.list||[]).map((e=>{const a=p.value.find((a=>a.id===e.petId)),o=null==e?void 0:e.payload;let i={};if(o&&"string"==typeof o)try{i=JSON.parse(o)}catch(d){console.warn("记录 payload 解析失败(字符串非 JSON):",null==e?void 0:e.id,o),i={}}else o&&"object"==typeof o&&(i=o);const l=function(e,a){if("diary"===(null==e?void 0:e.type)){const a=(null==e?void 0:e.payload)||{};return a.status||a.color?"shit":a.abnormalType||a.severity?"abnormal":"noting"}return{feed:"eating",water:"drinking",weight:"weight",clean:"washing",medicine:"medicine"}[null==e?void 0:e.type]||a||"noting"}({...e,payload:i},t),u=n[l]||n.noting;return{id:e.id,type:u,data:{time:e.time,petName:(null==a?void 0:a.name)||"",petAvatar:(null==a?void 0:a.avatarUrl)||"/static/index/add.png",...i}}}));if("diary"===i&&(r=r.filter((e=>{var a;return(null==(a=e.type)?void 0:a.key)===t}))),y.value=r,m.value=0,y.value.length>0){const e=y.value[m.value];l.value=e.type,d.value=e.data}else l.value=n[u.value]||n.eating,d.value={};setTimeout((()=>{L()}),100)}catch(s){console.warn("加载记录失败:",s),y.value=[],l.value=n[u.value]||n.eating,d.value={}}finally{a&&(b.value=!1)}}function P(e){const a=new Date(e);return`${a.getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}-${String(a.getDate()).padStart(2,"0")} ${String(a.getHours()).padStart(2,"0")}:${String(a.getMinutes()).padStart(2,"0")}`}function j(e){const a=e.detail.scrollLeft;let t=Math.round(a/750);if(t=Math.max(0,Math.min(t,y.value.length-1)),t!==m.value){if(m.value=t,y.value.length>0){const e=y.value[m.value];l.value=e.type,d.value=e.data}L()}}function F(){s.value=!0,Object.assign(v,d.value);const e=p.value.find((e=>e.name===d.value.petName));e&&(v.petId=e.id),Array.isArray(v.photos)||(v.photos=Array.isArray(d.value.photos)?[...d.value.photos]:[]),setTimeout((()=>{L()}),100)}function z(){s.value=!1,setTimeout((()=>{L()}),100)}async function O(){try{const a=await new Promise(((a,t)=>{e.index.chooseImage({count:9,sizeType:["compressed"],success:a,fail:t})})),o=(null==a?void 0:a.tempFilePaths)||[],i=await t.uploadImages(o);v.photos||(v.photos=[]),v.photos=[...v.photos,...i].slice(0,9)}catch(a){e.index.showToast({title:"选择图片失败",icon:"none"})}}function U(){if(y.value.length>0){Object.assign(y.value[m.value].data,v),d.value=y.value[m.value].data;const e=y.value[m.value];if(e.id)try{const a=e.type.key,t="noting"===a?{content:d.value.content,photos:d.value.photos||[]}:"eating"===a?{foodType:d.value.foodType,weight:d.value.weight,note:d.value.note}:"drinking"===a?{amount:d.value.amount,method:d.value.method,note:d.value.note}:"weight"===a?{weight:d.value.weight,method:d.value.method,note:d.value.note}:"washing"===a?{washType:d.value.washType,product:d.value.product,note:d.value.note}:"shit"===a?{status:d.value.status,color:d.value.color,note:d.value.note}:"abnormal"===a?{abnormalType:d.value.abnormalType,severity:d.value.severity,description:d.value.description}:"medicine"===a?{medicineName:d.value.medicineName,dosage:d.value.dosage,medicineTime:d.value.medicineTime,note:d.value.note}:{};o.api.updateRecord(e.id,{payload:t})}catch(a){}}s.value=!1,e.index.showToast({title:"保存成功",icon:"success"})}async function q(){e.index.showModal({title:"确认删除",content:`确定要删除这条${l.value.title}记录吗？`,confirmText:"删除",cancelText:"取消",confirmColor:"#ff4757",success:async a=>{if(a.confirm)try{const a=y.value[m.value];if(a&&a.id&&await o.api.deleteRecord(a.id),y.value.splice(m.value,1),0===y.value.length)return e.index.showToast({title:"删除成功",icon:"success"}),l.value=n[u.value]||n.eating,void(d.value={});m.value>=y.value.length&&(m.value=y.value.length-1);const t=y.value[m.value];l.value=t.type,d.value=t.data,e.index.showToast({title:"删除成功",icon:"success"})}catch(t){console.error("删除记录失败:",t),e.index.showToast({title:"删除失败",icon:"none"})}}})}function W(){var e,a;if(Object.keys(c).forEach((e=>delete c[e])),h.value=[],g.value=!1,!l.value||!l.value.key){const t=null==(a=null==(e=y.value[m.value])?void 0:e.type)?void 0:a.key;l.value=n[t]||n[u.value]||n.eating}r.value=!0}function R(){r.value=!1}async function B(){try{const a=await new Promise(((a,t)=>{e.index.chooseImage({count:9,sizeType:["compressed"],success:a,fail:t})})),o=(null==a?void 0:a.tempFilePaths)||[],i=await t.uploadImages(o);c.photos||(c.photos=[]),c.photos=[...c.photos,...i].slice(0,9)}catch(a){e.index.showToast({title:"选择图片失败",icon:"none"})}}function E(a,t){Array.isArray(a)&&0!==a.length&&e.index.previewImage({current:t,urls:a})}async function J(){if(0===h.value.length)return void e.index.showToast({title:"请选择宠物",icon:"none"});const a={eating:()=>({foodType:c.foodType,weight:c.weight,note:c.note}),drinking:()=>({amount:c.amount,method:c.method,note:c.note}),weight:()=>({weight:c.weight,method:c.method,note:c.note}),washing:()=>({washType:c.washType,product:c.product,note:c.note}),noting:()=>({content:c.content,photos:c.photos||[]}),shit:()=>({status:c.status,color:c.color,note:c.note}),abnormal:()=>({abnormalType:c.abnormalType,severity:c.severity,description:c.description}),medicine:()=>({medicineName:c.medicineName,dosage:c.dosage,medicineTime:c.medicineTime,note:c.note})},t=l.value.key,i={eating:"feed",drinking:"water",weight:"weight",washing:"clean",noting:"diary",shit:"diary",abnormal:"diary",medicine:"medicine"}[t]||"diary",u=a[t]?a[t]():a.noting();try{const a=[];for(const e of h.value){const l=p.value[e],d=await o.api.createRecord({petId:l.id,type:i,payload:u,time:(new Date).toISOString()});a.push({type:n[t]||n.noting,data:{time:(null==d?void 0:d.time)||(new Date).toISOString(),petName:l.name,petAvatar:l.avatarUrl||l.avatar||"/static/index/add.png",...u||{}}})}a.length>0&&(y.value=[...a,...y.value],m.value=0,l.value=a[0].type,d.value=a[0].data),e.index.showToast({title:"记录已保存",icon:"success"}),R(),await M({type:t})}catch(s){e.index.showToast({title:"保存失败",icon:"none"})}}function L(){const a=`#slide-${m.value}`;e.index.createSelectorQuery().select(a).boundingClientRect((e=>{e&&e.height?f.value=Math.max(e.height+120,900):f.value=900})).exec()}return e.index.$on&&e.index.$on("records:changed",D),e.onUnmounted((()=>{e.index.$off&&e.index.$off("records:changed",D)})),(t,o)=>e.e({a:b.value},b.value?{b:a._imports_0$9}:y.value.length>0?{d:e.f(y.value,((t,o,i)=>e.e({a:A(o)?1:"",b:_(o),c:t.type.icon,d:e.t(t.type.title),e:e.t(P(t.data.time))},s.value?{h:e.f(p.value,((a,t,o)=>({a:I(a.avatarUrl||a.avatar),b:e.t(a.name),c:a.id,d:v.petId===a.id?1:"",e:e.o((e=>function(e){v.petId=e.id,v.petName=e.name,v.petAvatar=e.avatar}(a)),a.id)})))}:{f:I(t.data.petAvatar),g:e.t(t.data.petName)},{i:"eating"===t.type.key},"eating"===t.type.key?e.e({j:!s.value},s.value?{l:v.foodType,m:e.o((e=>v.foodType=e.detail.value),o)}:{k:e.t(t.data.foodType||"未填写")},{n:!s.value},s.value?{p:v.weight,q:e.o(e.m((e=>v.weight=e.detail.value),{number:!0}),o)}:{o:e.t(t.data.weight?t.data.weight+"g":"未填写")},{r:!s.value},s.value?{t:v.note,v:e.o((e=>v.note=e.detail.value),o)}:{s:e.t(t.data.note||"无")}):"drinking"===t.type.key?e.e({x:!s.value},s.value?{z:v.amount,A:e.o(e.m((e=>v.amount=e.detail.value),{number:!0}),o)}:{y:e.t(t.data.amount?t.data.amount+"ml":"未填写")},{B:!s.value},s.value?{D:v.method,E:e.o((e=>v.method=e.detail.value),o)}:{C:e.t(t.data.method||"未填写")},{F:!s.value},s.value?{H:v.note,I:e.o((e=>v.note=e.detail.value),o)}:{G:e.t(t.data.note||"无")}):"weight"===t.type.key?e.e({K:!s.value},s.value?{M:v.weight,N:e.o(e.m((e=>v.weight=e.detail.value),{number:!0}),o)}:{L:e.t(t.data.weight?t.data.weight+"kg":"未填写")},{O:!s.value},s.value?{Q:v.method,R:e.o((e=>v.method=e.detail.value),o)}:{P:e.t(t.data.method||"未填写")},{S:!s.value},s.value?{U:v.note,V:e.o((e=>v.note=e.detail.value),o)}:{T:e.t(t.data.note||"无")}):"washing"===t.type.key?e.e({X:!s.value},s.value?{Z:v.washType,aa:e.o((e=>v.washType=e.detail.value),o)}:{Y:e.t(t.data.washType||"未填写")},{ab:!s.value},s.value?{ad:v.product,ae:e.o((e=>v.product=e.detail.value),o)}:{ac:e.t(t.data.product||"未填写")},{af:!s.value},s.value?{ah:v.note,ai:e.o((e=>v.note=e.detail.value),o)}:{ag:e.t(t.data.note||"无")}):"shit"===t.type.key?e.e({ak:!s.value},s.value?{am:v.status,an:e.o((e=>v.status=e.detail.value),o)}:{al:e.t(t.data.status||"未填写")},{ao:!s.value},s.value?{aq:v.color,ar:e.o((e=>v.color=e.detail.value),o)}:{ap:e.t(t.data.color||"未填写")},{as:!s.value},s.value?{av:v.note,aw:e.o((e=>v.note=e.detail.value),o)}:{at:e.t(t.data.note||"无")}):"noting"===t.type.key?e.e({ay:!s.value},s.value?{aA:v.content,aB:e.o((e=>v.content=e.detail.value),o)}:{az:e.t(t.data.content||"无内容")},{aC:s.value||t.data.photos&&t.data.photos.length},s.value||t.data.photos&&t.data.photos.length?e.e({aD:!s.value},s.value?{aF:e.f(v.photos||[],((a,t,o)=>({a:C(a),b:e.o((a=>function(a){v.photos&&e.index.showModal({title:"删除照片",content:"确定要删除这张照片吗？",confirmText:"删除",cancelText:"取消",confirmColor:"#ff4757",success:e=>{e.confirm&&v.photos.splice(a,1)}})}(t)),`edit-photo-${t}-${x.value}`),c:`edit-photo-${t}-${x.value}`,d:e.o((e=>E(v.photos||[],t)),`edit-photo-${t}-${x.value}`)}))),aG:e.o(O,o)}:{aE:e.f(t.data.photos,((a,o,i)=>({a:`photo-${o}-${x.value}`,b:C(a),c:e.o((e=>E(t.data.photos,o)),`photo-${o}-${x.value}`)})))}):{}):"abnormal"===t.type.key?e.e({aI:!s.value},s.value?{aK:v.abnormalType,aL:e.o((e=>v.abnormalType=e.detail.value),o)}:{aJ:e.t(t.data.abnormalType||"未填写")},{aM:!s.value},s.value?{aO:v.severity,aP:e.o((e=>v.severity=e.detail.value),o)}:{aN:e.t(t.data.severity||"未填写")},{aQ:!s.value},s.value?{aS:v.description,aT:e.o((e=>v.description=e.detail.value),o)}:{aR:e.t(t.data.description||"无")}):"medicine"===t.type.key?e.e({aV:!s.value},s.value?{aX:v.medicineName,aY:e.o((e=>v.medicineName=e.detail.value),o)}:{aW:e.t(t.data.medicineName||"未填写")},{aZ:!s.value},s.value?{bb:v.dosage,bc:e.o((e=>v.dosage=e.detail.value),o)}:{ba:e.t(t.data.dosage||"未填写")},{bd:!s.value},s.value?{bf:v.medicineTime,bg:e.o((e=>v.medicineTime=e.detail.value),o)}:{be:e.t(t.data.medicineTime||"未填写")},{bh:!s.value},s.value?{bj:v.note,bk:e.o((e=>v.note=e.detail.value),o)}:{bi:e.t(t.data.note||"无")}):{},{w:"drinking"===t.type.key,J:"weight"===t.type.key,W:"washing"===t.type.key,aj:"shit"===t.type.key,ax:"noting"===t.type.key,aH:"abnormal"===t.type.key,aU:"medicine"===t.type.key},s.value?{bn:e.o(z,o),bo:e.o(U,o)}:{bl:a._imports_1$5,bm:e.o(F,o)},s.value?{}:{bp:a._imports_0$4,bq:e.o(q,o)},{br:S(o)?1:"",bs:N(o),bt:o,bv:`slide-${o}`}))),e:!s.value,f:!s.value,g:!s.value,h:s.value?1:"",i:y.value.length,j:w.value,k:e.o(j),l:f.value+"px"}:{},{c:y.value.length>0,m:!b.value&&y.value.length>0},!b.value&&y.value.length>0?{n:e.f(y.value,((a,t,o)=>({a:t,b:e.n({active:t===m.value}),c:e.o((e=>function(e){if(m.value=e,w.value=750*e,y.value.length>0){const e=y.value[m.value];l.value=e.type,d.value=e.data}L()}(t)),t)})))}:b.value?{}:{p:a._imports_0$9},{o:!b.value,q:a._imports_3$1,r:e.o(W),s:r.value},r.value?e.e({t:e.t(l.value.title),v:e.o(R),w:e.f(p.value,((a,t,o)=>e.e({a:I(a.avatarUrl||a.avatar),b:e.t(a.name),c:h.value.includes(t)},(h.value.includes(t),{}),{d:t,e:h.value.includes(t)?1:"",f:e.o((e=>function(e){const a=h.value.indexOf(e);a>-1?h.value.splice(a,1):h.value.push(e),c.selectedPets=h.value.map((e=>p.value[e]))}(t)),t)}))),x:"eating"===l.value.key},"eating"===l.value.key?{y:c.foodType,z:e.o((e=>c.foodType=e.detail.value)),A:c.weight,B:e.o(e.m((e=>c.weight=e.detail.value),{number:!0})),C:c.note,D:e.o((e=>c.note=e.detail.value))}:"drinking"===l.value.key?{F:c.amount,G:e.o(e.m((e=>c.amount=e.detail.value),{number:!0})),H:c.method,I:e.o((e=>c.method=e.detail.value)),J:c.note,K:e.o((e=>c.note=e.detail.value))}:"weight"===l.value.key?{M:c.weight,N:e.o(e.m((e=>c.weight=e.detail.value),{number:!0})),O:c.method,P:e.o((e=>c.method=e.detail.value)),Q:c.note,R:e.o((e=>c.note=e.detail.value))}:"washing"===l.value.key?{T:c.washType,U:e.o((e=>c.washType=e.detail.value)),V:c.product,W:e.o((e=>c.product=e.detail.value)),X:c.note,Y:e.o((e=>c.note=e.detail.value))}:"shit"===l.value.key?{aa:c.status,ab:e.o((e=>c.status=e.detail.value)),ac:c.color,ad:e.o((e=>c.color=e.detail.value)),ae:c.note,af:e.o((e=>c.note=e.detail.value))}:"noting"===l.value.key?{ah:c.content,ai:e.o((e=>c.content=e.detail.value)),aj:e.f(c.photos||[],((a,t,o)=>({a:C(a),b:e.o((a=>{return o=t,void(c.photos&&e.index.showModal({title:"删除照片",content:"确定要删除这张照片吗？",confirmText:"删除",cancelText:"取消",confirmColor:"#ff4757",success:e=>{e.confirm&&c.photos.splice(o,1)}}));var o}),`new-photo-${t}-${x.value}`),c:`new-photo-${t}-${x.value}`,d:e.o((e=>E(c.photos||[],t)),`new-photo-${t}-${x.value}`)}))),ak:e.o(B)}:"abnormal"===l.value.key?{am:c.abnormalType,an:e.o((e=>c.abnormalType=e.detail.value)),ao:c.severity,ap:e.o((e=>c.severity=e.detail.value)),aq:c.description,ar:e.o((e=>c.description=e.detail.value))}:"medicine"===l.value.key?{at:c.medicineName,av:e.o((e=>c.medicineName=e.detail.value)),aw:c.dosage,ax:e.o((e=>c.dosage=e.detail.value)),ay:c.medicineTime,az:e.o((e=>c.medicineTime=e.detail.value)),aA:c.note,aB:e.o((e=>c.note=e.detail.value))}:{},{E:"drinking"===l.value.key,L:"weight"===l.value.key,S:"washing"===l.value.key,Z:"shit"===l.value.key,ag:"noting"===l.value.key,al:"abnormal"===l.value.key,as:"medicine"===l.value.key,aC:e.o(R),aD:e.o(J),aE:e.o((()=>{})),aF:e.o(R)}):{})}},n=e._export_sfc(i,[["__scopeId","data-v-5b026ee5"]]);wx.createPage(n);
