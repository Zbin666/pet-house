"use strict";const e=require("../../common/vendor.js"),t=require("../../common/assets.js"),n=require("../../utils/api.js"),i=e.defineComponent({__name:"questionDetail",setup(i){var o,a;const s=e.ref("");e.onMounted((async()=>{try{const i=e.index.getSystemInfoSync(),o=(i.statusBarHeight,i.screenWidth,15);s.value=`padding-top:${o}px;`;try{const e=await n.api.getPets(),t=Array.isArray(e)?e:e.data||[];t.length>0&&(u.value=t[0])}catch(t){console.error("获取宠物信息失败:",t)}try{const e=await n.api.getProfile();h.value=(null==e?void 0:e.id)||(null==e?void 0:e.userId)||""}catch(t){}}catch(t){s.value=""}}));const l=e.reactive({id:"",title:"问题标题",content:"",isUrgent:!1,hasAnswer:!1,doctor:null,answerPreview:"",answerCount:0,readCount:0,followCount:0,time:"",user:{id:"",nickname:"",avatarUrl:""},pet:null,answers:[],isOwner:!1,isFollowed:!1}),c=e.ref(""),r=e.ref(!1);e.ref(!1);const u=e.ref(null),d=e.ref(null),m=e.ref(null),v=e.ref(null),p=e.ref(null),h=e.ref(""),w=new Map,f=e.ref(0);function g(t){if(!t)return"/static/user/user.png";let n=t;return n.startsWith("/uploads/")&&(n=`https://pet-api.zbinli.cn${n}`),n.startsWith("http://pet-api.zbinli.cn")&&(n=n.replace("http://pet-api.zbinli.cn","https://pet-api.zbinli.cn")),n=n.replace("://pet-api.zbinli.cn:80","://pet-api.zbinli.cn"),n.startsWith("wxfile://")||n.startsWith("/static/")?n:w.has(n)?w.get(n):(e.index.downloadFile({url:n,success:e=>{200===e.statusCode&&e.tempFilePath?(w.set(n,e.tempFilePath),f.value++):(w.set(n,"/static/user/user.png"),f.value++)},fail:()=>{w.set(n,"/static/user/user.png"),f.value++}}),"/static/user/user.png")}async function x(t){try{const e=await n.api.getQuestion(t);let i="刚刚";e.createdAt&&(i=T(e.createdAt));const o=e.answers.map((e=>{let t="刚刚";return e.createdAt&&(t=T(e.createdAt)),{...e,time:t,comments:[],newComment:"",showComments:!1,expandedComments:0}}));Object.assign(l,{...e,time:i,answers:o,readCount:e.views||0});for(const t of l.answers)await C(t.id)}catch(i){console.error("加载问答详情失败:",i),e.index.showToast({title:"加载失败",icon:"none"})}}async function y(){try{const i=await n.api.followQuestion(l.id);if(i){l.followCount=i.followCount,l.isFollowed=i.isFollowed,e.index.showToast({title:l.isFollowed?"已关注":"已取消关注",icon:"none",duration:1e3});try{e.index.$emit("qa:refresh")}catch(t){}}}catch(i){console.error("关注操作失败:",i),e.index.showToast({title:"操作失败",icon:"none"})}}async function C(e){try{const t=await n.api.getAnswerComments(e);console.log("加载评论数据:",t);const i=l.answers.find((t=>t.id===e));i&&(i.comments=t.map(((e,t)=>({...e,time:k(e.createdAt),replies:[],replyCount:e.replyCount||(t%2==0?5:0),showReplies:!1,expandedReplies:0}))),console.log("更新后的回答评论:",i.comments))}catch(t){console.error("加载评论失败:",t)}}function T(e){const t=new Date,n=e.split("T")[0],i=e.split("T")[1].split(".")[0],[o,a,s]=n.split("-").map(Number),[l,c]=i.split(":").map(Number),r=365*(t.getFullYear()-o)*24*60+30*(t.getMonth()+1-a)*24*60+24*(t.getDate()-s)*60+60*(t.getHours()-l)+(t.getMinutes()-c);if(r<1440){if(r<1)return"刚刚";if(r<60)return`${r}分钟前`;return`${Math.floor(r/60)}小时前`}return`${a}/${s} ${l.toString().padStart(2,"0")}:${c.toString().padStart(2,"0")}`}function k(e){return T(e)}function $(){d.value=null,m.value=null,v.value=null,c.value="",p.value&&p.value.blur()}async function A(){try{await new Promise(((t,i)=>{e.index.showModal({title:"删除确认",content:"确定要删除这个问答吗？删除后将无法恢复。",confirmText:"删除",confirmColor:"#e64340",success:async o=>{if(o.confirm)try{await n.api.deleteQuestion(l.id),e.index.showToast({title:"已删除",icon:"success"}),setTimeout((()=>{e.index.navigateBack()}),1500),t(!0)}catch(a){e.index.showToast({title:"删除失败",icon:"none"}),i(a)}else t(!1)}})}))}catch(t){}}try{const e=null==(a=null==(o=getCurrentPages().pop())?void 0:o.getOpenerEventChannel)?void 0:a.call(o);e&&e.on("qa",(e=>{Object.assign(l,{id:e.id,title:e.title,content:e.content,isUrgent:e.isUrgent,user:e.user,pet:e.pet}),e.id&&x(e.id)}))}catch(b){}return e.onLoad((()=>{try{e.index.setNavigationBarTitle({title:"问答详情"}),e.index.setNavigationBarColor({frontColor:"#000000",backgroundColor:"#fff1a8"})}catch(b){}})),(i,o)=>e.e({a:l.isUrgent},(l.isUrgent,{}),{b:e.t(l.title),c:e.t(l.isFollowed?"已关注":"关注问题"),d:l.isFollowed?1:"",e:e.o(y),f:e.t(l.content),g:g(l.user.avatarUrl),h:`qa-user-avatar-${f.value}`,i:e.t(l.user.nickname||"用户"),j:e.t(l.time),k:l.user.id===h.value},l.user.id===h.value?{l:t._imports_0$4,m:e.o(A)}:{},{n:e.f(l.answers,((i,o,a)=>{var s,r;return e.e({a:g(i.user.avatarUrl),b:`answer-avatar-${i.id}-${f.value}`,c:e.t(i.user.nickname),d:i.pet&&i.pet.name},i.pet&&i.pet.name?{e:e.t(i.pet.name),f:e.t(i.pet.breed)}:{},{g:e.t(i.content),h:e.t(i.time),i:e.o((e=>function(e){v.value=e,d.value=null,m.value=null,c.value=""}(i)),i.id),j:i.isLiked?"/static/community/good-active.png":"/static/community/good.png",k:i.likes>0},i.likes>0?{l:e.t(i.likes)}:{},{m:e.o((t=>async function(t){try{const i=await n.api.likeAnswer(t.id);if(i){t.likes=i.likes,t.isLiked=i.isLiked,e.index.showToast({title:t.isLiked?"已点赞":"已取消点赞",icon:"none",duration:1e3});try{e.index.$emit("qa:refresh")}catch(b){}}}catch(i){console.error("点赞操作失败:",i),e.index.showToast({title:"操作失败",icon:"none"})}}(i)),i.id),n:(null==(s=i.user)?void 0:s.id)===h.value},(null==(r=i.user)?void 0:r.id)===h.value?{o:t._imports_0$4,p:e.o((t=>async function(t){try{await new Promise(((i,o)=>{e.index.showModal({title:"删除确认",content:"确定要删除这条回答吗？",confirmText:"删除",confirmColor:"#e64340",success:async a=>{if(a.confirm)try{await n.api.deleteAnswer(t.id);const o=l.answers.findIndex((e=>e.id===t.id));-1!==o&&l.answers.splice(o,1),e.index.showToast({title:"已删除",icon:"success"}),i(!0)}catch(b){e.index.showToast({title:"删除失败",icon:"none"}),o(b)}else i(!1)}})}))}catch(i){}}(i)),i.id)}:{},{q:i.showComments&&i.comments&&i.comments.length},i.showComments&&i.comments&&i.comments.length?{r:e.f(i.comments.slice(0,i.expandedComments),((o,a,s)=>{var l,r;return e.e({a:g(o.user.avatarUrl),b:`comment-avatar-${o.id}-${f.value}`,c:e.t(o.user.nickname),d:o.replyTo&&o.replyTo.nickname},o.replyTo&&o.replyTo.nickname?{e:e.t(o.replyTo.nickname)}:{},{f:o.pet&&o.pet.name},o.pet&&o.pet.name?{g:e.t(o.pet.name),h:e.t(o.pet.breed)}:{},{i:e.t(o.content),j:e.t(o.time),k:e.o((e=>function(e,t){d.value=e,m.value=t,v.value=null,c.value=""}(o,i)),o.id),l:o.isLiked?"/static/community/good-active.png":"/static/community/good.png",m:o.likes>0},o.likes>0?{n:e.t(o.likes)}:{},{o:e.o((t=>async function(t){try{const i=await n.api.likeAnswerComment(t.id);i&&(t.likes=i.likes,t.isLiked=i.isLiked,e.index.showToast({title:t.isLiked?"已点赞":"已取消点赞",icon:"none",duration:1e3}))}catch(i){console.error("点赞评论失败:",i),e.index.showToast({title:"操作失败",icon:"none"})}}(o)),o.id),p:(null==(l=o.user)?void 0:l.id)===h.value},(null==(r=o.user)?void 0:r.id)===h.value?{q:t._imports_0$4,r:e.o((t=>async function(t,i){try{await new Promise(((o,a)=>{e.index.showModal({title:"删除确认",content:"确定要删除这条评论吗？",confirmText:"删除",confirmColor:"#e64340",success:async s=>{if(s.confirm)try{await n.api.deleteAnswerComment(i.id);const a=t.comments.findIndex((e=>e.id===i.id));-1!==a&&(t.comments.splice(a,1),t.expandedComments>t.comments.length&&(t.expandedComments=t.comments.length)),e.index.showToast({title:"已删除",icon:"success"}),o(!0)}catch(b){e.index.showToast({title:"删除失败",icon:"none"}),a(b)}else o(!1)}})}))}catch(o){}}(i,o)),o.id)}:{},{s:o.id})})),s:e.o((()=>{}),i.id)}:{},{t:i.comments&&i.comments.length>0},i.comments&&i.comments.length>0?e.e({v:!i.showComments},i.showComments?e.e({y:i.expandedComments<i.comments.length},i.expandedComments<i.comments.length?{z:e.o((e=>function(e){e.expandedComments=Math.min(e.expandedComments+10,e.comments.length)}(i)),i.id)}:{},{A:e.o((e=>function(e){e.showComments=!1,e.expandedComments=0}(i)),i.id)}):{w:e.t(i.comments.length),x:e.o((e=>function(e){e.showComments=!0,e.expandedComments=Math.min(3,e.comments.length)}(i)),i.id)}):{},{B:i.id})})),o:0===l.answers.length},(l.answers.length,{}),{p:e.o($),q:d.value?`回复 ${d.value.user.nickname}：`:v.value?`回复 ${v.value.user.nickname}：`:"输入你的回答",r:r.value,s:null!==d.value||null!==v.value,t:e.o((t=>d.value?async function(){var t,i;if(c.value.trim()){if(d.value&&m.value&&!r.value)try{r.value=!0;const o=await n.api.createAnswerComment(m.value.id,{content:c.value.trim(),petId:(null==(t=u.value)?void 0:t.id)||null,replyToCommentId:(null==(i=d.value)?void 0:i.id)||null});m.value.comments.unshift({...o,time:k(o.createdAt)}),m.value.showComments=!0,m.value.expandedComments=Math.min(m.value.comments.length,Math.max(m.value.expandedComments+1,3)),d.value=null,m.value=null,c.value="",e.index.showToast({title:"回复成功",icon:"success"})}catch(o){console.error("提交回复失败:",o),e.index.showToast({title:"回复失败",icon:"none"})}finally{r.value=!1}}else e.index.showToast({title:"请输入回复内容",icon:"none"})}():v.value?async function(){var t;if(c.value.trim()){if(v.value&&!r.value)try{r.value=!0;const i=await n.api.createAnswerComment(v.value.id,{content:c.value.trim(),petId:(null==(t=u.value)?void 0:t.id)||null});v.value.comments.unshift({...i,time:k(i.createdAt)}),v.value.showComments=!0,v.value.expandedComments=Math.min(v.value.comments.length,Math.max(v.value.expandedComments+1,3)),v.value=null,c.value="",e.index.showToast({title:"回复成功",icon:"success"})}catch(i){console.error("提交回复失败:",i),e.index.showToast({title:"回复失败",icon:"none"})}finally{r.value=!1}}else e.index.showToast({title:"请输入回复内容",icon:"none"})}():async function(){var t;if(c.value.trim()){if(!r.value)try{r.value=!0,await n.api.createAnswer(l.id,{content:c.value.trim(),petId:(null==(t=u.value)?void 0:t.id)||null}),e.index.showToast({title:"回答成功",icon:"success"}),c.value="",await x(l.id);try{e.index.$emit("qa:refresh")}catch(b){}}catch(i){console.error("提交回答失败:",i),e.index.showToast({title:"提交失败",icon:"none"})}finally{r.value=!1}}else e.index.showToast({title:"请输入回答内容",icon:"none"})}())),v:e.o((()=>{})),w:c.value,x:e.o((e=>c.value=e.detail.value)),y:e.o((()=>{})),z:e.s(s.value)})}}),o=e._export_sfc(i,[["__scopeId","data-v-f6d11a15"]]);wx.createPage(o);
