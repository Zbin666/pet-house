"use strict";const e=require("../../common/vendor.js"),t=require("../../common/assets.js"),i=require("../../utils/api.js"),s={__name:"communityDetail",setup(s){const a=e.ref("");e.onMounted((async()=>{try{const s=e.index.getSystemInfoSync(),n=(s.statusBarHeight,s.screenWidth,15);a.value=`padding-top:${n}px;`;try{const e=await i.api.getProfile();e&&e.id&&(r.value=e.id)}catch(t){}try{const e=await i.api.getPets(),t=Array.isArray(e)?e:e.data||[];t.length>0&&(d.value=t[0])}catch(t){console.error("获取宠物信息失败:",t)}}catch(t){a.value=""}}));const n=e.reactive({id:"",user:"昵称",text:"这是一条圈子动态内容。",cover:"/static/logo.png",likes:0,avatar:"/static/logo.png",pet:"",breed:"",images:[],shares:0,isLiked:!1,time:""}),l=e.ref(""),o=e.reactive([]),r=e.ref(""),c=e.computed((()=>{try{return o.reduce(((e,t)=>e+1+(t.replies&&t.replies.length||0)),0)}catch(e){return o.length}})),d=e.ref(null),p=e.ref(null),u=e.ref(null),m=e.ref(null),v=new Map,h=e.ref(0),g=new Map,f=e.ref(0);function x(t){if(!t)return"/static/user/user.png";let i=t;return i.startsWith("/uploads/")&&(i=`https://pet-api.zbinli.cn${i}`),i.startsWith("http://pet-api.zbinli.cn")&&(i=i.replace("http://pet-api.zbinli.cn","https://pet-api.zbinli.cn")),i=i.replace("://pet-api.zbinli.cn:80","://pet-api.zbinli.cn"),i.startsWith("wxfile://")||i.startsWith("/static/")?i:v.has(i)?v.get(i):(e.index.downloadFile({url:i,success:e=>{200===e.statusCode&&e.tempFilePath?(v.set(i,e.tempFilePath),h.value++):(v.set(i,"/static/user/user.png"),h.value++)},fail:()=>{v.set(i,"/static/user/user.png"),h.value++}}),"/static/user/user.png")}function y(t){if(!t)return"/static/404.png";let i=t;return i.startsWith("/uploads/")&&(i=`https://pet-api.zbinli.cn${i}`),i.startsWith("http://pet-api.zbinli.cn")&&(i=i.replace("http://pet-api.zbinli.cn","https://pet-api.zbinli.cn")),i=i.replace("://pet-api.zbinli.cn:80","://pet-api.zbinli.cn"),i.startsWith("wxfile://")||i.startsWith("/static/")?i:g.has(i)?g.get(i):(e.index.downloadFile({url:i,success:e=>{200===e.statusCode&&e.tempFilePath?(g.set(i,e.tempFilePath),f.value++):(g.set(i,"/static/404.png"),f.value++)},fail:()=>{g.set(i,"/static/404.png"),f.value++}}),"/static/404.png")}function w(e){const t=new Date,i=e.split("T")[0],s=e.split("T")[1].split(".")[0],[a,n,l]=i.split("-").map(Number),[o,r]=s.split(":").map(Number),c=365*(t.getFullYear()-a)*24*60+30*(t.getMonth()+1-n)*24*60+24*(t.getDate()-l)*60+60*(t.getHours()-o)+(t.getMinutes()-r);if(c<1440){if(c<1)return"刚刚";if(c<60)return`${c}分钟前`;return`${Math.floor(c/60)}小时前`}return`${n}/${l} ${o.toString().padStart(2,"0")}:${r.toString().padStart(2,"0")}`}async function k(t){var s;try{const l=await i.api.getFeed(t),c=l.User||{},d=l.Pet||{};n.id=l.id,n.userId=l.userId||(null==(s=l.User)?void 0:s.id)||"",n.user=c.nickname||"昵称",n.pet=d.name||"",n.breed=d.breed||"",n.text=l.text||"",n.avatar=c.avatarUrl||"/static/logo.png",n.images=Array.isArray(l.images)?l.images:[],n.cover=n.images[0]?n.images[0]:l.cover||"/static/logo.png",n.likes=l.likes||0,n.shares=l.shares||0,n.isLiked=l.isLiked||!1;let p="";if(l.tags&&Array.isArray(l.tags)&&l.tags.length>0)p=l.tags[0];else if(l.tags&&"string"==typeof l.tags)try{const e=JSON.parse(l.tags);Array.isArray(e)&&e.length>0&&(p=e[0])}catch(a){}n.title=p?`#${p}`:"",l.createdAt?n.time=w(l.createdAt):n.time="",await async function(t){try{if(!r.value)try{const e=await i.api.getProfile();e&&e.id&&(r.value=e.id)}catch(a){console.error("获取用户信息失败:",a)}const n=await i.api.getComments(t);o.splice(0,o.length,...n.map((e=>{var t,i,s,a;let n="";e.createdAt&&(n=w(e.createdAt));const l=(e.replies||[]).map((e=>{var t,i,s,a;let n="";return e.createdAt&&(n=w(e.createdAt)),{id:e.id,userId:e.userId,user:(null==(t=e.User)?void 0:t.nickname)||"用户",petName:(null==(i=e.Pet)?void 0:i.name)||"",petBreed:(null==(s=e.Pet)?void 0:s.breed)||"",time:n,avatar:(null==(a=e.User)?void 0:a.avatarUrl)||"/static/logo.png",content:e.content,likes:e.likes||0,isLiked:e.isLiked||!1,replyToUser:e.replyToUser||"",showReplies:!1,expandedReplies:3}}));return{id:e.id,userId:e.userId,user:(null==(t=e.User)?void 0:t.nickname)||"用户",petName:(null==(i=e.Pet)?void 0:i.name)||"",petBreed:(null==(s=e.Pet)?void 0:s.breed)||"",time:n,avatar:(null==(a=e.User)?void 0:a.avatarUrl)||"/static/logo.png",text:e.text,likes:e.likes||0,isLiked:e.isLiked||!1,isSelf:!!r.value&&e.userId===r.value,replies:l,showReplies:!1,expandedReplies:0}})));try{const t=e.index.getStorageSync("lastRepliedCommentId");if(t){const i=o.find((e=>e.id===t));i&&(i.showReplies=!0,i.expandedReplies=Math.min(Math.max(i.expandedReplies||0,3),i.replies.length)),e.index.removeStorageSync("lastRepliedCommentId")}}catch(s){}}catch(a){console.error("加载评论失败:",a)}}(t)}catch(a){e.index.showToast({title:"加载失败",icon:"none"})}}function T(){e.index.showToast({title:"分享功能开发中",icon:"none"})}async function R(){try{await new Promise(((t,s)=>{e.index.showModal({title:"删除确认",content:"确定要删除这条动态吗？删除后将无法恢复。",confirmText:"删除",confirmColor:"#e64340",success:async a=>{if(a.confirm)try{await i.api.deleteFeed(n.id),e.index.showToast({title:"已删除",icon:"success"}),setTimeout((()=>{e.index.navigateBack()}),1500),t(!0)}catch(l){e.index.showToast({title:"删除失败",icon:"none"}),s(l)}else t(!1)}})}))}catch(t){}}async function $(){try{const t=await i.api.likeFeed(n.id);t&&(n.likes=t.likes,n.isLiked=t.isLiked,e.index.showToast({title:n.isLiked?"已点赞":"已取消点赞",icon:"none",duration:1e3}))}catch(t){console.error("点赞操作失败:",t),e.index.showToast({title:"操作失败",icon:"none"})}}async function b(){var t,s,a,r,c,m,v,h,g,f;if(l.value.trim())try{if(p.value){const n={text:l.value.trim(),petId:(null==(t=d.value)?void 0:t.id)||null,replyToUserId:u.value?u.value.userId:p.value?p.value.userId:null},m=await i.api.createCommentReply(p.value.id,n);let v="刚刚";m.createdAt&&(v=w(m.createdAt));const h={id:m.id,user:(null==(s=m.User)?void 0:s.nickname)||"我",petName:(null==(a=m.Pet)?void 0:a.name)||"",petBreed:(null==(r=m.Pet)?void 0:r.breed)||"",time:v,avatar:(null==(c=m.User)?void 0:c.avatarUrl)||"/static/logo.png",content:m.content,likes:0,isLiked:!1,replyToUser:m.replyToUser||(u.value?u.value.user:p.value?p.value.user:""),showReplies:!1,expandedReplies:3},g=o.find((e=>e.id===p.value.id));if(g){g.replies.unshift(h),g.showReplies=!0,g.expandedReplies=Math.min(Math.max(g.expandedReplies||0,3)+1,g.replies.length);try{e.index.setStorageSync("lastRepliedCommentId",g.id)}catch(x){}}l.value="",p.value=null,u.value=null,e.index.showToast({title:"回复提交成功",icon:"success"})}else{const t={text:l.value.trim(),petId:(null==(m=d.value)?void 0:m.id)||null},s=await i.api.createComment(n.id,t);let a="刚刚";s.createdAt&&(a=w(s.createdAt));const r={id:s.id,user:(null==(v=s.User)?void 0:v.nickname)||"我",petName:(null==(h=s.Pet)?void 0:h.name)||"",petBreed:(null==(g=s.Pet)?void 0:g.breed)||"",time:a,avatar:(null==(f=s.User)?void 0:f.avatarUrl)||"/static/logo.png",text:s.text,likes:0,isLiked:!1,replies:[],showReplies:!1,expandedReplies:3};o.push(r),l.value="",e.index.showToast({title:"评论提交成功",icon:"success"})}}catch(y){e.index.showToast({title:"提交失败",icon:"none"})}else e.index.showToast({title:"请输入评论内容",icon:"none"})}return e.onLoad((e=>{var t,i;const s=null==(i=null==(t=getCurrentPages().pop())?void 0:t.getOpenerEventChannel)?void 0:i.call(t);let a=null;try{s&&s.on("post",(e=>{a=e}))}catch(l){}setTimeout((()=>{e&&e.id||a&&a.id?k(e&&e.id||a.id):a&&(n.id=a.id||"",n.user=a.user||"昵称",n.pet=a.pet||"",n.breed=a.breed||"",n.text=a.text||"",n.avatar=a.avatar||"/static/logo.png",n.images=Array.isArray(a.images)?a.images:[],n.cover=n.images[0]?n.images[0]:a.cover||"/static/logo.png",n.likes=a.likes||0,n.shares=a.shares||0)}),0)})),(s,d)=>e.e({a:x(n.avatar),b:`post-avatar-${h.value}`,c:e.t(n.user),d:e.t(n.pet),e:e.t(n.breed),f:e.t(n.time),g:n.title},n.title?{h:e.t(n.title)}:{},{i:e.t(n.text),j:n.images&&n.images.length},n.images&&n.images.length?{k:e.f(n.images,((t,i,s)=>({a:`pic-${i}-${f.value}`,b:y(t),c:e.o((t=>{return s=n.images,a=i,void(s&&0!==s.length&&e.index.previewImage({current:a,urls:s,success:()=>{console.log("图片预览成功")},fail:t=>{console.error("图片预览失败:",t),e.index.showToast({title:"图片预览失败",icon:"none"})}}));var s,a}),`pic-${i}-${f.value}`)})))}:{},{l:t._imports_0$6,m:e.t(n.shares),n:t._imports_1$1,o:e.t(o.length),p:n.isLiked?"/static/community/good-active.png":"/static/community/good.png",q:e.t(n.likes),r:e.o($),s:n.userId===r.value},n.userId===r.value?{t:t._imports_0$4,v:e.o(R)}:{},{w:e.t(c.value),x:e.f(o,((s,a,c)=>e.e({a:x(s.avatar),b:`comment-avatar-${s.id}-${h.value}`,c:e.t(s.user),d:s.petName},s.petName?{e:e.t(s.petName),f:e.t(s.petBreed)}:{},{g:e.t(s.text),h:e.t(s.time),i:e.o((t=>function(t){p.value=t,u.value=null,l.value="",e.nextTick$1((()=>{m.value&&m.value.focus()}))}(s)),s.id),j:s.isLiked?"/static/community/good-active.png":"/static/community/good.png",k:s.likes>0},s.likes>0?{l:e.t(s.likes)}:{},{m:e.o((t=>async function(t){try{const s=await i.api.likeComment(t.id);s&&(t.likes=s.likes,t.isLiked=s.isLiked,e.index.showToast({title:t.isLiked?"已点赞":"已取消点赞",icon:"none",duration:1e3}))}catch(s){console.error("点赞评论失败:",s),e.index.showToast({title:"操作失败",icon:"none"})}}(s)),s.id),n:s.userId===r.value},s.userId===r.value?{o:t._imports_0$4,p:e.o((t=>async function(t){try{await new Promise(((s,a)=>{e.index.showModal({title:"删除确认",content:"确定要删除这条评论及其回复吗？",confirmText:"删除",confirmColor:"#e64340",success:async l=>{if(l.confirm)try{await i.api.deleteComment(t.id);const a=o.findIndex((e=>e.id===t.id));-1!==a&&o.splice(a,1);try{n&&n.shares}catch(r){}e.index.showToast({title:"已删除",icon:"success"}),s(!0)}catch(c){e.index.showToast({title:"删除失败",icon:"none"}),a(c)}else s(!1)}})}))}catch(s){}}(s)),s.id)}:{},{q:s.showReplies&&s.replies&&s.replies.length>0},s.showReplies&&s.replies&&s.replies.length>0?{r:e.f(s.replies.slice(0,s.expandedReplies||0),((a,n,o)=>e.e({a:x(a.avatar),b:`reply-avatar-${a.id}-${h.value}`,c:e.t(a.user),d:a.replyToUser},a.replyToUser?{e:e.t(a.replyToUser)}:{},{f:a.petName},a.petName?{g:e.t(a.petName),h:e.t(a.petBreed)}:{},{i:e.t(a.content),j:e.t(a.time),k:e.o((t=>function(t,i){p.value=t,u.value=i,l.value="",e.nextTick$1((()=>{m.value&&m.value.focus()}))}(s,a)),a.id),l:a.isLiked?"/static/community/good-active.png":"/static/community/good.png",m:a.likes>0},a.likes>0?{n:e.t(a.likes)}:{},{o:e.o((t=>async function(t){try{const s=await i.api.likeCommentReply(t.id);s&&(t.likes=s.likes,t.isLiked=s.isLiked,e.index.showToast({title:t.isLiked?"已点赞":"已取消点赞",icon:"none",duration:1e3}))}catch(s){console.error("点赞回复失败:",s),e.index.showToast({title:"操作失败",icon:"none"})}}(a)),a.id),p:a.userId===r.value},a.userId===r.value?{q:t._imports_0$4,r:e.o((t=>async function(t,s){try{await new Promise(((a,n)=>{e.index.showModal({title:"删除确认",content:"确定要删除这条回复吗？",confirmText:"删除",confirmColor:"#e64340",success:async l=>{if(l.confirm)try{await i.api.deleteCommentReply(s.id);const n=t.replies.findIndex((e=>e.id===s.id));-1!==n&&t.replies.splice(n,1),e.index.showToast({title:"已删除",icon:"success"}),a(!0)}catch(o){e.index.showToast({title:"删除失败",icon:"none"}),n(o)}else a(!1)}})}))}catch(a){}}(s,a)),a.id)}:{},{s:a.id})))}:{},{s:s.replies&&s.replies.length>0},s.replies&&s.replies.length>0?e.e({t:!s.showReplies},s.showReplies?e.e({x:(s.expandedReplies||0)<s.replies.length},(s.expandedReplies||0)<s.replies.length?{y:e.o((e=>function(e){e.expandedReplies=Math.min((e.expandedReplies||0)+10,e.replies.length)}(s)),s.id)}:{},{z:e.o((e=>function(e){e.showReplies=!1,e.expandedReplies=0}(s)),s.id)}):{v:e.t(s.replies.length),w:e.o((e=>function(e){e.showReplies=!0,e.expandedReplies=Math.min(3,e.replies.length)}(s)),s.id)}):{},{A:s.id}))),y:t._imports_0$6,z:e.o(T),A:n.isLiked?"/static/community/good-active.png":"/static/community/good.png",B:e.o($),C:u.value?`回复 ${u.value.user}：`:p.value?`回复 ${p.value.user}：`:"输入你的评论",D:null!==p.value||null!==u.value,E:e.o(b),F:l.value,G:e.o((e=>l.value=e.detail.value)),H:e.o((()=>{})),I:e.s(a.value)})}},a=e._export_sfc(s,[["__scopeId","data-v-44a7257d"]]);wx.createPage(a);
